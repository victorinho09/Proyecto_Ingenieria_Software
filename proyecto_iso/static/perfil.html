<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- Meta tags básicos -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Proyecto Ingeniería del Software - ISO 2025/2026</title>
    <meta
      name="description"
      content="Proyecto web para la asignatura de Ingeniería del Software - Universidad 2025/2026"
    />
    <meta
      name="keywords"
      content="ingeniería software, proyecto web, fastapi, html, css, javascript"
    />
    <meta name="author" content="Victor Vega Martinez" />

    <!-- Pre-conect google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Allura&display=swap" rel="stylesheet">

    <!-- CSS personalizado -->
    <link rel="stylesheet" href="/static/saborea.css">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/cocinero.png">
  </head>
  <body class="bg-light d-flex flex-column min-vh-100">
    <!-- Navegación principal -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">
          <span class="lh-1" style="font-family:'Allura',cursive; font-size:2.8rem;">Saborea</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Inicio</a>
            </li>

            <li class="nav-item dropdown d-flex align-items-center">
              <a class="nav-link" href="/recetas">Recetas</a>
              <a
                class="nav-link dropdown-toggle dropdown-toggle-split px-1"
                href="#"
                id="navbarRecetas"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="Más opciones de Recetas"
              >
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end bg-primary bg-opacity-75 border-0 rounded-3 shadow py-2"
                aria-labelledby="navbarRecetas"
              >
                <li><a class="nav-link" href="/mis-recetas">Mis Recetas</a></li>
                <li>
                  <a class="nav-link" href="/recetas-guardadas"
                    >Recetas Guardadas</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/menu-semanal">Menú Semanal</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/comunidad">Comunidad</a>
            </li>
          </ul>
          

          <span class="navbar-text text-light me-3">
            <a
              class="bi bi-person-circle nav-link active"
              href="/perfil"
              style="text-decoration: none"
            >
              <i>Perfil</i>
            </a>
          </span>

          <button
            type="button"
            class="btn btn-outline-light ms-2"
            data-bs-toggle="modal"
            data-bs-target="#cerrarSesionModal"
          >
            <i class="bi bi-box-arrow-in-left"></i> Cerrar Sesión
          </button>
        </div>
      </div>
    </nav>

    <main class="container my-4">
      <!-- Banner que indica modo edición (hidden por defecto) -->
      <div id="editModeBanner" class="alert alert-warning text-center fw-bold d-none" role="status" style="margin-bottom:16px;">
        MODO EDICIÓN ACTIVADO — Los cambios no se guardan hasta pulsar Guardar. Pulsa Esc o Cancelar para salir sin guardar.
      </div>
      <div class="row">
        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="card-body text-center">
              <div id="perfilImagenWrap" class="mb-3">
                <img id="perfilImagen" src="/static/cocinero.png" alt="Foto de perfil" class="rounded-circle img-fluid" style="width:140px;height:140px;object-fit:cover;">
              </div>
              <h5 id="perfilNombre" class="card-title">Usuario</h5>
              <p id="perfilEmail" class="text-muted small">email@ejemplo.com</p>

              <div class="d-flex gap-2 justify-content-center mt-3" id="perfilActions">
                <button id="btnEditarPerfil" class="btn btn-outline-primary btn-sm" type="button">Editar perfil</button>

                <!-- Contenedor visible solo en modo edición: fila Guardar | Cancelar y debajo Cambiar contraseña -->
                <div id="editarControls" class="d-none d-flex flex-column align-items-center">
                  <div class="d-flex gap-2">
                    <button id="btnGuardarPerfil" class="btn btn-primary btn-sm" type="button">Guardar</button>
                    <button id="btnCancelarPerfil" class="btn btn-secondary btn-sm" type="button">Cancelar</button>
                  </div>
                  <button id="btnCambiarPassword" class="btn btn-outline-secondary btn-sm mt-2 d-none" type="button">Cambiar contraseña</button>
                </div>
              </div>

              <div id="mensajeEdicion" style="display:none" class="mt-2"></div>

              <!-- Inline edit controls (hidden until edit mode) -->
              <input id="perfilNombreInput" type="text" class="form-control mt-2" style="display:none;" required>
              <input id="perfilFotoInputInline" type="file" accept="image/*" style="display:none; margin-top:8px;">

              <div id="mensajeFoto" style="display:none" class="mt-2"></div>
            </div>
          </div>

          <div class="card mt-3 shadow-sm">
            <div class="card-body">
              <h6 class="mb-2">Valoración</h6>
              <div id="perfilValoracion" class="text-warning">—</div>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <h4 class="card-title">Recetas</h4>
              <p class="card-text">Aquí puedes ver algunos datos tu cuenta.</p>

              <div class="row text-center mt-4">
                <div class="col-4">
                  <div class="fw-bold" id="countPropias">0</div>
                  <div class="small text-muted">Recetas publicadas</div>
                </div>
                <div class="col-4">
                  <div class="fw-bold" id="countHechas">0</div>
                  <div class="small text-muted">Recetas hechas</div>
                </div>
                <div class="col-4">
                  <div class="fw-bold" id="countGuardadas">0</div>
                  <div class="small text-muted">Recetas guardadas</div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light border-top mt-auto">
      <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <img src="/static/cocinero.png" alt="Logo" style="height: 16px;" class="me-2">
            <span class="text-muted small">Saborea</span>
          </div>
          <div class="text-muted small">© 2025 • ISO 2025/2026</div>
        </div>
      </div>
    </footer>

    <!-- Modal de Cerrar Sesión -->
    <div
      class="modal fade"
      id="cerrarSesionModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cerrarSesionModalLabel">
              Cerrar Sesión
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Contenedor para mensajes -->
            <div
              id="mensajeContainer"
              class="alert"
              style="display: none"
            ></div>
            <form id="cerrarSesionForm" action="/cerrar-sesion" method="POST">
              <div id="mensajeCerrarSesion" class="alert alert-warning">
                ¿Estás seguro de querer cerrar sesión?
              </div>
            </form>
          </div>
          <div class="modal-footer" id="modalFooter">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="cerrarSesionForm"
              class="btn btn-primary"
            >
              Cerrar Sesión
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Cambiar Nombre de Usuario -->
    <div class="modal fade" id="cambiarNombreModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cambio nombre usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <label for="modalInputNombre" class="form-label">Nuevo nombre de usuario</label>
            <input id="modalInputNombre" type="text" class="form-control" placeholder="Introduce el nuevo nombre de usuario" required>
            <div id="modalMensajeNombre" style="display:none" class="mt-2"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="modalGuardarNombre" type="button" class="btn btn-primary">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Cambiar Foto de Perfil -->
    <div class="modal fade" id="cambiarFotoModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cambio foto perfil</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <label for="modalInputFoto" class="form-label">Selecciona una imagen</label>
            <input id="modalInputFoto" type="file" class="form-control" accept="image/*" required>
            <div id="modalMensajeFoto" style="display:none" class="mt-2"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="modalGuardarFoto" type="button" class="btn btn-primary">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Confirmar salida sin guardar (cuando hay cambios en modo edición) -->
    <!-- Modal Cambiar Contraseña -->
    <div class="modal fade" id="cambiarPasswordModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cambiar contraseña</h5>
            <button id="modalCerrarPassword" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div id="modalMensajePassword" style="display:none" class="mt-2"></div>
            <div class="mb-3">
              <label for="modalInputPasswordActual" class="form-label">Contraseña actual</label>
              <input id="modalInputPasswordActual" type="password" class="form-control" placeholder="Introduce tu contraseña actual" required>
            </div>
            <div class="mb-3">
              <label for="modalInputPasswordNueva" class="form-label">Nueva contraseña</label>
              <input id="modalInputPasswordNueva" type="password" class="form-control" placeholder="Introduce la nueva contraseña" required>
            </div>
            <div class="mb-3">
              <label for="modalInputPasswordConfirm" class="form-label">Confirmar nueva contraseña</label>
              <input id="modalInputPasswordConfirm" type="password" class="form-control" placeholder="Repite la nueva contraseña" required>
            </div>
          </div>
          <div class="modal-footer">
            <button id="modalCancelarPassword" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="modalGuardarPassword" type="button" class="btn btn-primary">Cambiar contraseña</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="confirmSalirModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Salir sin guardar</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p>Estás en modo edición y hay cambios sin guardar. ¿Seguro que quieres salir y perder los cambios?</p>
          </div>
          <div class="modal-footer">
            <button id="cancelSalirBtn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="confirmSalirBtn" type="button" class="btn btn-danger">Salir y descartar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script para dropdowns en hover -->
    <script>
      document
        .querySelectorAll(".nav-item.dropdown")
        .forEach(function (dropdown) {
          const toggle = dropdown.querySelector('[data-bs-toggle="dropdown"]');
          const dd = new bootstrap.Dropdown(toggle, {
            popperConfig: { strategy: "fixed" },
          });

          dropdown.addEventListener("mouseenter", () => dd.show());
          dropdown.addEventListener("mouseleave", () => dd.hide());
        });
    </script>

    <!-- JavaScript de la aplicación -->
    <script type="module" src="/static/js/main.js"></script>
    <script type="module">
      import { mostrarMensaje } from '/static/js/components/message-handler.js';
      // Módulo para manejar la sección de perfil
      async function cargarPerfil() {
        try {
          const res = await fetch('/api/perfil', { credentials: 'include' });
          const json = await res.json();
          if (!res.ok) {
            console.error('Error al obtener perfil', json);
            return;
          }

          const perfil = json.perfil || json.data?.perfil || json?.perfil || (json.data && json.data.perfil);
          // Crear fallback por compatibilidad con la estructura de crear_respuesta_exito
          const data = json.perfil ? json.perfil : (json.data && json.data.perfil ? json.data.perfil : (json.data && json.data.perfil ? json.data.perfil : json.data));
          const perfilData = json.data?.perfil || json.perfil || (json.perfil && json.perfil) || (json.data && json.data) || perfil;

          // Manejo flexible: buscar en respuesta estandar
          const perfilObj = json.data && json.data.perfil ? json.data.perfil : (json.perfil ? json.perfil : json.data);

          const p = perfilObj || perfil || perfilData || {};

          document.getElementById('perfilEmail').textContent = p.email || '';
          document.getElementById('perfilNombre').textContent = p.nombreUsuario || '';
          if (p.fotoPerfil) {
            document.getElementById('perfilImagen').src = p.fotoPerfil;
          }

          document.getElementById('countPropias').textContent = p.totalPublicadas ?? p.totalPropias ?? 0;
          document.getElementById('countGuardadas').textContent = p.totalGuardadas ?? 0;
          document.getElementById('countHechas').textContent = p.totalHechas ?? 0;

          // Valoración: por ahora mostrar guion si no hay dato
          const val = p.valoracion || null;
          document.getElementById('perfilValoracion').textContent = val ? val.toFixed(1) : '—';

        } catch (err) {
          console.error('Error cargando perfil:', err);
        }

        // Update navbar if available so changes reflect without full reload
        try {
          if (window.actualizarNavbarUsuario) window.actualizarNavbarUsuario();
        } catch (e) {
          console.error('Error actualizando navbar', e);
        }
      }

      async function subirFoto(archivo) {
        const mensaje = document.getElementById('mensajeFoto');
        mensaje.style.display = 'none';
        try {
          const form = new FormData();
          form.append('archivo', archivo);

          const res = await fetch('/api/subir-foto-perfil', {
            method: 'POST',
            credentials: 'include',
            body: form
          });
          const json = await res.json();
          if (!res.ok) {
            mensaje.className = 'alert alert-danger small mt-2';
            mensaje.textContent = json.mensaje || 'Error subiendo la foto';
            mensaje.style.display = 'block';
            return;
          }

          const fotoUrl = json.data?.fotoPerfil || json.fotoPerfil || json.data?.fotoPerfil || json.fotoPerfil;
          if (fotoUrl) {
            document.getElementById('perfilImagen').src = fotoUrl;
            mensaje.className = 'alert alert-success small mt-2';
            mensaje.textContent = 'Foto subida correctamente';
            mensaje.style.display = 'block';
            // Update navbar thumbnail if available
            try {
              if (window.actualizarNavbarUsuario) window.actualizarNavbarUsuario();
            } catch (e) {
              console.error('Error actualizando navbar tras subir foto', e);
            }
          }
        } catch (err) {
          mensaje.className = 'alert alert-danger small mt-2';
          mensaje.textContent = 'Error de conexión al subir la foto';
          mensaje.style.display = 'block';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        cargarPerfil();

        // Inline Edit Mode: single Edit button that enables editing name and photo
        const modalFotoEl = document.getElementById('cambiarFotoModal');
        const modalFotoInstance = new bootstrap.Modal(modalFotoEl);
        const modalFotoInput = document.getElementById('modalInputFoto');
        const modalFotoGuardar = document.getElementById('modalGuardarFoto');
        const modalFotoMensaje = document.getElementById('modalMensajeFoto');

        const btnEditar = document.getElementById('btnEditarPerfil');
        const btnGuardar = document.getElementById('btnGuardarPerfil');
        const btnCancelar = document.getElementById('btnCancelarPerfil');
        const mensajeEdicion = document.getElementById('mensajeEdicion');

  const perfilNombreEl = document.getElementById('perfilNombre');
  const perfilNombreInput = document.getElementById('perfilNombreInput');
        const perfilImagenEl = document.getElementById('perfilImagen');
        const perfilFotoInputInline = document.getElementById('perfilFotoInputInline');
  let escListener = null;

        function enterEditMode() {
          // show inputs, swap buttons
          perfilNombreInput.value = perfilNombreEl.textContent.trim();
          perfilNombreEl.style.display = 'none';
          perfilNombreInput.style.display = 'block';
          perfilFotoInputInline.value = '';
          perfilFotoInputInline.style.display = 'block';
          btnEditar.classList.add('d-none');
          const editarControls = document.getElementById('editarControls');
          if (editarControls) editarControls.classList.remove('d-none');
          // Mostrar el botón de cambiar contraseña dentro de editarControls
          const btnCambiar = document.getElementById('btnCambiarPassword');
          if (btnCambiar) btnCambiar.classList.remove('d-none');
          mensajeEdicion.style.display = 'none';
          setTimeout(() => perfilNombreInput.focus(), 100);
          
          // Attach Escape key listener to cancel edit mode
          escListener = (ev) => {
            if (ev.key === 'Escape') {
              ev.preventDefault();
              mensajeEdicion.style.display = 'none';
              try { mostrarMensaje('Edición cancelada', 'error', 2500); } catch (e) {}
              exitEditMode(true);
            }
          };
          document.addEventListener('keydown', escListener);
          // Show visual banner indicating edit mode
          const banner = document.getElementById('editModeBanner');
          if (banner) {
            banner.classList.remove('d-none');
          }
        }

        function exitEditMode(revert = true) {
          // hide inputs, restore view
          perfilNombreEl.style.display = 'block';
          perfilNombreInput.style.display = 'none';
          perfilFotoInputInline.style.display = 'none';
          perfilFotoInputInline.value = '';
          btnEditar.classList.remove('d-none');
          const editarControlsHide = document.getElementById('editarControls');
          if (editarControlsHide) editarControlsHide.classList.add('d-none');
          // Ocultar botón de cambiar contraseña al salir del modo edición
          const btnCambiarHide = document.getElementById('btnCambiarPassword');
          if (btnCambiarHide) btnCambiarHide.classList.add('d-none');
          // Remove Escape key listener when leaving edit mode
          if (escListener) {
            document.removeEventListener('keydown', escListener);
            escListener = null;
          }
          // Hide visual banner indicating edit mode
          const banner = document.getElementById('editModeBanner');
          if (banner) {
            banner.classList.add('d-none');
          }
        }

        btnEditar.addEventListener('click', () => {
          enterEditMode();
        });

        btnCancelar.addEventListener('click', () => {
          // discard changes
          mensajeEdicion.style.display = 'none';
          try { mostrarMensaje('Edición cancelada', 'error', 2500); } catch (e) {}
          exitEditMode(true);
        });

        // Allow submitting the inline photo input with Enter
        perfilFotoInputInline.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            btnGuardar.click();
          }
        });

        btnGuardar.addEventListener('click', async () => {
          // Validate name with native tooltip
          mensajeEdicion.style.display = 'none';
          if (!perfilNombreInput.reportValidity()) return;

          const nuevoNombre = perfilNombreInput.value.trim();
          const archivo = perfilFotoInputInline.files[0];

          btnGuardar.disabled = true;
          try {
            // If there's a file, upload it first
            if (archivo) {
              const form = new FormData();
              form.append('archivo', archivo);
              const resFoto = await fetch('/api/subir-foto-perfil', {
                method: 'POST',
                credentials: 'include',
                body: form
              });
              const jf = await resFoto.json();
              if (!resFoto.ok) {
                mensajeEdicion.className = 'alert alert-danger small mt-2';
                mensajeEdicion.textContent = jf.mensaje || 'Error subiendo la foto';
                mensajeEdicion.style.display = 'block';
                btnGuardar.disabled = false;
                return;
              }
            }

            // Update username if changed
            const currentName = perfilNombreEl.textContent.trim();
            if (nuevoNombre && nuevoNombre !== currentName) {
              const resNombre = await fetch('/api/actualizar-usuario', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombreUsuario: nuevoNombre })
              });
              const jn = await resNombre.json();
              if (!resNombre.ok) {
                mensajeEdicion.className = 'alert alert-danger small mt-2';
                mensajeEdicion.textContent = jn.mensaje || 'Error actualizando el nombre';
                mensajeEdicion.style.display = 'block';
                btnGuardar.disabled = false;
                return;
              }
            }

            // All good: refresh profile and exit edit mode
            await cargarPerfil();
            // Mostrar mensaje flotante verde (consistente con crear receta / login)
            try { mostrarMensaje('Perfil actualizado correctamente', 'success'); } catch (e) { /* fallback silent */ }
            // Cerrar modo edición tras una pequeña pausa (sin mostrar mensaje inline)
            setTimeout(() => {
              exitEditMode(false);
            }, 800);

          } catch (err) {
            mensajeEdicion.className = 'alert alert-danger small mt-2';
            mensajeEdicion.textContent = 'Error de conexión al guardar cambios';
            mensajeEdicion.style.display = 'block';
          } finally {
            btnGuardar.disabled = false;
          }
        });

        // --- Navigation guard when in edit mode ---
        let pendingNavigationHref = null;
        let beforeUnloadHandler = null;
        let linkClickHandler = null;
        const confirmSalirEl = document.getElementById('confirmSalirModal');
        const confirmSalirInstance = confirmSalirEl ? new bootstrap.Modal(confirmSalirEl) : null;
        const confirmSalirBtn = document.getElementById('confirmSalirBtn');
        const cancelSalirBtn = document.getElementById('cancelSalirBtn');

        function attachNavigationGuard() {
          // beforeunload -> native browser confirmation if user tries to close/refresh
          beforeUnloadHandler = function (e) {
            e.preventDefault();
            e.returnValue = '';
            return '';
          };
          window.addEventListener('beforeunload', beforeUnloadHandler);

          // Intercept clicks on internal links and show our modal
          linkClickHandler = function (ev) {
            // Only handle left-clicks without modifier keys
            if (ev.defaultPrevented) return;
            if (ev.button !== 0) return; // not left-click
            if (ev.metaKey || ev.ctrlKey || ev.shiftKey || ev.altKey) return;

            const a = ev.target.closest && ev.target.closest('a');
            if (!a || !a.href) return;
            // Skip anchors that open in new tab or are javascript or same-page
            if (a.target && a.target !== '' && a.target !== '_self') return;
            const href = a.getAttribute('href') || a.href;
            if (!href) return;
            if (href.startsWith('#') || href.startsWith('javascript:')) return;
            // If link is to same location (hash change) allow
            const url = new URL(a.href, location.href);
            if (url.pathname === location.pathname && url.search === location.search) return;

            // If element toggles a bootstrap modal or has data-bs-toggle, don't intercept
            if (a.hasAttribute('data-bs-toggle')) return;

            // Prevent navigation and show modal
            ev.preventDefault();
            pendingNavigationHref = a.href;
            if (confirmSalirInstance) confirmSalirInstance.show();
          };

          document.addEventListener('click', linkClickHandler, true);
        }

        function detachNavigationGuard() {
          if (beforeUnloadHandler) {
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            beforeUnloadHandler = null;
          }
          if (linkClickHandler) {
            document.removeEventListener('click', linkClickHandler, true);
            linkClickHandler = null;
          }
          pendingNavigationHref = null;
        }

        // Wire modal buttons: confirm -> navigate, cancel -> just close modal
        if (confirmSalirBtn) {
          confirmSalirBtn.addEventListener('click', () => {
            if (confirmSalirInstance) confirmSalirInstance.hide();
            // Show red toast indicating cancellation (shorter duration)
            try { mostrarMensaje('Edición cancelada', 'error', 2500); } catch (e) {}
            // Ensure edit mode is closed
            try { exitEditMode(true); } catch (e) {}
            // Remove guard to allow navigation without being blocked by beforeunload
            detachNavigationGuard();
            if (pendingNavigationHref) {
              // Give the toast a brief moment to appear before navigating
              setTimeout(() => {
                window.location.href = pendingNavigationHref;
              }, 400);
            }
          });
        }

        if (cancelSalirBtn) {
          cancelSalirBtn.addEventListener('click', () => {
            pendingNavigationHref = null;
            if (confirmSalirInstance) confirmSalirInstance.hide();
          });
        }

        // Hook attach/detach into enter/exit edit mode
        const origEnter = enterEditMode;
        const origExit = exitEditMode;
        enterEditMode = function () {
          origEnter();
          attachNavigationGuard();
        };
        exitEditMode = function (revert = true) {
          detachNavigationGuard();
          origExit(revert);
        };

        // Manejo del modal para cambiar nombre de usuario
        const btnAbrir = document.getElementById('btnAbrirCambiarNombre');
        const modalEl = document.getElementById('cambiarNombreModal');
        const modalInstance = new bootstrap.Modal(modalEl);
        const modalInput = document.getElementById('modalInputNombre');
        const modalGuardar = document.getElementById('modalGuardarNombre');
        const modalMensaje = document.getElementById('modalMensajeNombre');

        if (btnAbrir) {
          btnAbrir.addEventListener('click', () => {
            // Open modal empty by default (do not prefill)
            modalInput.value = '';
            modalMensaje.style.display = 'none';
            modalGuardar.disabled = false;
            modalInstance.show();
            setTimeout(() => modalInput.focus(), 200);
          });
        }

        // Clear modal when hidden to ensure it opens empty
        modalEl.addEventListener('hidden.bs.modal', () => {
          modalInput.value = '';
          modalMensaje.style.display = 'none';
          modalGuardar.disabled = false;
        });

        // --- Manejo del modal para cambiar contraseña ---
        const btnAbrirPassword = document.getElementById('btnCambiarPassword');
        const modalPasswordEl = document.getElementById('cambiarPasswordModal');
        const modalPasswordInstance = modalPasswordEl ? new bootstrap.Modal(modalPasswordEl) : null;
        const inputPasswordActual = document.getElementById('modalInputPasswordActual');
        const inputPasswordNueva = document.getElementById('modalInputPasswordNueva');
        const inputPasswordConfirm = document.getElementById('modalInputPasswordConfirm');
        const modalGuardarPassword = document.getElementById('modalGuardarPassword');
        const modalMensajePassword = document.getElementById('modalMensajePassword');

        if (btnAbrirPassword) {
          btnAbrirPassword.addEventListener('click', () => {
            if (!modalPasswordInstance) return;
            // Clear inputs
            inputPasswordActual.value = '';
            inputPasswordNueva.value = '';
            inputPasswordConfirm.value = '';
            modalMensajePassword.style.display = 'none';
            modalGuardarPassword.disabled = false;
            modalPasswordInstance.show();
            setTimeout(() => inputPasswordActual.focus(), 150);
          });
        }

        // Mostrar mensaje cuando el usuario cancela el modal (botón Cancelar o cerrar)
        const modalCancelarBtn = document.getElementById('modalCancelarPassword');
        const modalCerrarBtn = document.getElementById('modalCerrarPassword');
        // reason flag: null = no explicit action (e.g. backdrop), 'cancel' = cancelled by user button/close, 'success' = saved successfully
        let passwordModalCloseReason = null;
        function onPasswordModalCancelled() {
          try { mostrarMensaje('Cambio de contraseña cancelado', 'error'); } catch (e) {}
          passwordModalCloseReason = 'cancel';
        }
        if (modalCancelarBtn) {
          modalCancelarBtn.addEventListener('click', () => {
            onPasswordModalCancelled();
          });
        }
        if (modalCerrarBtn) {
          modalCerrarBtn.addEventListener('click', () => {
            onPasswordModalCancelled();
          });
        }

        if (modalPasswordEl) {
          modalPasswordEl.addEventListener('hidden.bs.modal', () => {
            // If modal was closed by backdrop (no explicit cancel or success), show cancel toast
            if (passwordModalCloseReason === null) {
              try { mostrarMensaje('Cambio de contraseña cancelado', 'error'); } catch (e) {}
            }
            // Reset reason for next open
            passwordModalCloseReason = null;
            inputPasswordActual.value = '';
            inputPasswordNueva.value = '';
            inputPasswordConfirm.value = '';
            modalMensajePassword.style.display = 'none';
            modalGuardarPassword.disabled = false;
          });
        }

        modalGuardarPassword.addEventListener('click', async () => {
          modalMensajePassword.style.display = 'none';
          // Use native validation first (so browser shows tooltips like other modals)
          if (!inputPasswordActual.reportValidity() || !inputPasswordNueva.reportValidity() || !inputPasswordConfirm.reportValidity()) {
            return;
          }

          // Basic client-side validation
          if (!inputPasswordActual.value || !inputPasswordNueva.value || !inputPasswordConfirm.value) {
            modalMensajePassword.className = 'alert alert-danger small mt-2';
            modalMensajePassword.textContent = 'Rellena todos los campos';
            modalMensajePassword.style.display = 'block';
            return;
          }
          if (inputPasswordNueva.value !== inputPasswordConfirm.value) {
            modalMensajePassword.className = 'alert alert-danger small mt-2';
            modalMensajePassword.textContent = 'La nueva contraseña y la confirmación no coinciden';
            modalMensajePassword.style.display = 'block';
            return;
          }

          // La nueva contraseña no puede ser igual a la actual
          if (inputPasswordActual.value === inputPasswordNueva.value) {
            modalMensajePassword.className = 'alert alert-danger small mt-2';
            modalMensajePassword.textContent = 'La nueva contraseña no puede ser igual a la actual';
            modalMensajePassword.style.display = 'block';
            return;
          }

          modalGuardarPassword.disabled = true;
          try {
            const res = await fetch('/api/cambiar-password', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ currentPassword: inputPasswordActual.value, newPassword: inputPasswordNueva.value, confirmPassword: inputPasswordConfirm.value })
            });
            const j = await res.json();
            if (!res.ok) {
              modalMensajePassword.className = 'alert alert-danger small mt-2';
              modalMensajePassword.textContent = j.mensaje || 'Error al cambiar la contraseña';
              modalMensajePassword.style.display = 'block';
              modalGuardarPassword.disabled = false;
              return;
            }

            modalMensajePassword.className = 'alert alert-success small mt-2';
            modalMensajePassword.textContent = j.mensaje || 'Contraseña cambiada correctamente';
            modalMensajePassword.style.display = 'block';
            try { mostrarMensaje(j.mensaje || 'Contraseña cambiada correctamente', 'success'); } catch (e) {}
            passwordModalCloseReason = 'success';
            setTimeout(() => {
              if (modalPasswordInstance) modalPasswordInstance.hide();
            }, 900);
          } catch (err) {
            modalMensajePassword.className = 'alert alert-danger small mt-2';
            modalMensajePassword.textContent = 'Error de conexión al cambiar la contraseña';
            modalMensajePassword.style.display = 'block';
          } finally {
            modalGuardarPassword.disabled = false;
          }
        });
+
        // Allow submitting the password modal with Enter when focused on any input
        [inputPasswordActual, inputPasswordNueva, inputPasswordConfirm].forEach((el) => {
          if (!el) return;
          el.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
              ev.preventDefault();
              if (modalGuardarPassword) modalGuardarPassword.click();
            }
          });
        });

        // Allow confirming the name change with Enter while input is focused
        modalInput.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            // Trigger the same action as clicking the guardar button
            modalGuardar.click();
          }
        });

        // Allow submitting the photo modal with Enter when file input focused
        modalFotoInput.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            modalFotoGuardar.click();
          }
        });

        modalGuardar.addEventListener('click', async () => {
          // Use native browser validation tooltip (reportValidity) so the tooltip
          // matches other forms like "crear receta". If invalid, stop and let
          // the browser show the validation bubble.
          modalMensaje.style.display = 'none';
          if (!modalInput.reportValidity()) {
            return;
          }
          const nuevo = modalInput.value.trim();

          modalGuardar.disabled = true;
          try {
            const res = await fetch('/api/actualizar-usuario', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ nombreUsuario: nuevo })
            });
            const j = await res.json();
            if (!res.ok) {
              modalMensaje.className = 'alert alert-danger small mt-2';
              modalMensaje.textContent = j.mensaje || 'Error al actualizar nombre';
              modalMensaje.style.display = 'block';
              modalGuardar.disabled = false;
              return;
            }

            // Actualizar UI y cerrar modal
            document.getElementById('perfilNombre').textContent = nuevo;
            modalMensaje.className = 'alert alert-success small mt-2';
            modalMensaje.textContent = 'Nombre actualizado correctamente';
            modalMensaje.style.display = 'block';
            // Refresh navbar to show new username immediately
            try {
              if (window.actualizarNavbarUsuario) window.actualizarNavbarUsuario();
            } catch (e) {
              console.error('Error actualizando navbar tras cambiar nombre', e);
            }
            setTimeout(() => {
              modalInstance.hide();
            }, 700);
          } catch (err) {
            modalMensaje.className = 'alert alert-danger small mt-2';
            modalMensaje.textContent = 'Error de conexión al actualizar nombre';
            modalMensaje.style.display = 'block';
          } finally {
            modalGuardar.disabled = false;
          }
        });
      });
    </script>
  </body>
</html>
