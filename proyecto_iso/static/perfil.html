<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- Meta tags básicos -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Proyecto Ingeniería del Software - ISO 2025/2026</title>
    <meta
      name="description"
      content="Proyecto web para la asignatura de Ingeniería del Software - Universidad 2025/2026"
    />
    <meta
      name="keywords"
      content="ingeniería software, proyecto web, fastapi, html, css, javascript"
    />
    <meta name="author" content="Victor Vega Martinez" />

    <!-- Pre-conect google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Allura&display=swap" rel="stylesheet">

    <!-- CSS personalizado -->
    <link rel="stylesheet" href="/static/saborea.css">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/cocinero.png">
    
    <!-- Estilos específicos para la página de perfil (solo aquí) -->
    <style>
      /* Hero: roomy, centered, responsive (no overlaps) */
      .profile-hero{
        background: linear-gradient(180deg, rgba(255,158,44,0.12), rgba(255,241,224,0.18));
        border-radius: 14px; padding: 36px 22px; margin-bottom: 20px; box-shadow: 0 14px 36px rgba(0,0,0,0.06);
      }
      .profile-hero .hero-inner{ display:flex; align-items:center; gap:1.4rem; flex-wrap:wrap; }
      .profile-hero .hero-inner .hero-avatar{ width:180px; height:180px; border-radius:999px; overflow:hidden; flex:0 0 180px; }
      .profile-hero .hero-inner h2{ margin:0; font-size:1.6rem; font-weight:800; color:var(--saborea-choco); }
      .profile-hero .hero-metrics{ margin-left:auto; display:flex; gap:1.2rem; align-items:center; flex-wrap:wrap; }
      .profile-hero .metric{ text-align:center; min-width:86px; }
      .profile-hero .metric .metric-number{ display:block; font-size:1.25rem; font-weight:800; }
      .profile-hero .metric .metric-label{ font-size:.78rem; color: #7a6f66; }

      /* Remove overlap behavior; ensure normal document flow */
      #perfilCard{ margin-top: 18px; }

      /* Keep some vertical spacing where the image would be */
      #perfilCard .card-body{ padding-top: 1.25rem; }

      /* Edit controls spacing */
      #perfilActions{ margin-top:10px; }

      /* Action buttons on profile: more emphasis */
      #btnEditarPerfil{ border-radius:999px; padding:.5rem 1rem; font-weight:700; }
      #btnGuardarPerfil, #btnCancelarPerfil{ min-width:110px; }

      /* Restore earlier visual style for edit-mode banner and buttons (based on screenshot)
         - Banner: pale yellow, rounded, bold brown text
         - Guardar: mango filled, larger, shadow
         - Cancelar: dark grey filled
         - Cambiar contraseña: outline with subtle radius
      */
      #editModeBanner{
        background-color: color-mix(in oklab, var(--saborea-warning, #FFE9C8) 70%, #fff);
        border-radius: 10px;
        padding: 10px 14px;
        color: var(--saborea-choco);
        font-weight:800;
        box-shadow: 0 6px 18px rgba(58,47,42,0.06);
        margin-bottom:18px !important;
      }

      /* Guardar (primary) prominent style for perfil page */
      #btnGuardarPerfil{
        background: linear-gradient(180deg, var(--saborea-mango), color-mix(in oklab, var(--saborea-mango) 86%, #000));
        border-color: transparent;
        color:#fff;
        box-shadow: 0 10px 20px rgba(255,158,44,0.18);
        padding:.5rem 1.05rem;
        border-radius: 28px;
        font-weight:800;
      }

      /* Cancelar as dark rounded button */
      #btnCancelarPerfil{
        background: #5c5c5c; color:#fff; border-color: transparent; border-radius: 28px; padding:.45rem .95rem; font-weight:700;
        box-shadow: 0 6px 14px rgba(0,0,0,0.08);
      }

      /* Cambiar contraseña as subtle outline pill */
      #btnCambiarPassword{
        border-radius: 22px; padding:.35rem .8rem; border:1px solid color-mix(in oklab, var(--saborea-mango) 24%, #ddd); background:transparent; color:var(--saborea-choco);
      }

      /* Input focus for name to match orange accent */
      #perfilNombreInput:focus{
        outline: none; box-shadow: 0 6px 18px rgba(255,158,44,0.12); border: 2px solid var(--saborea-mango);
      }
      /* Make file input look tactile */
      #perfilFotoInputInline{ border-radius:8px; padding:.35rem; }
      /* Ensure hero stacks nicely on small screens */
      @media (max-width: 768px){
        .profile-hero .hero-metrics{ width:100%; justify-content:flex-start; margin-top:12px; }
        .profile-hero .hero-inner{ gap:1rem; }
      }
      .hero-edit-btn{ border-radius:999px; padding:.35rem .8rem; font-weight:700; }
    </style>
  </head>
  <body class="bg-light d-flex flex-column min-vh-100">
    <!-- Navegación principal -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">
          <span class="lh-1" style="font-family:'Allura',cursive; font-size:2.8rem;">Saborea</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Inicio</a>
            </li>

            <li class="nav-item dropdown d-flex align-items-center">
              <a class="nav-link" href="/recetas">Recetas</a>
              <a
                class="nav-link dropdown-toggle dropdown-toggle-split px-1"
                href="#"
                id="navbarRecetas"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="Más opciones de Recetas"
              >
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end bg-primary bg-opacity-75 border-0 rounded-3 shadow py-2"
                aria-labelledby="navbarRecetas"
              >
                <li><a class="nav-link" href="/mis-recetas">Mis Recetas</a></li>
                <li>
                  <a class="nav-link" href="/recetas-guardadas"
                    >Recetas Guardadas</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/menu-semanal">Menú Semanal</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/comunidad">Comunidad</a>
            </li>
          </ul>
          

          <span class="navbar-text text-light me-3">
            <a
              class="bi bi-person-circle nav-link active"
              href="/perfil"
              style="text-decoration: none"
            >
              <i>Perfil</i>
            </a>
          </span>

          <button
            type="button"
            class="btn btn-outline-light ms-2"
            data-bs-toggle="modal"
            data-bs-target="#cerrarSesionModal"
          >
            <i class="bi bi-box-arrow-in-left"></i> Cerrar Sesión
          </button>
        </div>
      </div>
    </nav>

    <main class="container my-4">
      <!-- Hero específico de perfil -->
      <div class="profile-hero">
        <div class="container">
          <div class="hero-inner">
            <div class="hero-avatar" style="width:180px; height:180px; overflow:hidden; border-radius:50%;">
              <img id="heroAvatarImg" src="/static/cocinero.png" alt="avatar" class="hero-avatar-img" style="width:100%; height:100%; max-width:100%; max-height:100%; object-fit:contain; object-position:center center; border-radius:50%; display:block;">
            </div>
            <div>
              <h2 id="heroNombre">Usuario</h2>
              <div id="heroEmail" style="color:#7a6f66;font-size:0.95rem;">email@ejemplo.com</div>
            </div>
              <div class="hero-metrics">
              <div class="metric text-end">
                <button id="btnEditarPerfilHero" class="btn btn-outline-primary hero-edit-btn" type="button" aria-label="Editar perfil" data-bs-toggle="modal" data-bs-target="#perfilEditModal">Editar perfil</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Banner que indica modo edición (hidden por defecto) -->
      <div id="editModeBanner" class="alert alert-warning text-center fw-bold d-none" role="status" style="margin-bottom:16px;">
        MODO EDICIÓN ACTIVADO — Los cambios no se guardan hasta pulsar Guardar. Pulsa Esc o Cancelar para salir sin guardar.
      </div>
      <div class="row">
        <div class="col-md-4">
          <div class="card mt-3 shadow-sm">
            <div class="card-body">
              <h4 class="card-title">Valoración</h4>
              <div id="perfilValoracion" class="rating-display text-center">
                <div class="rating-number" id="perfilValoracionNumero">—</div>
                <div class="rating-stars mt-1" id="perfilValoracionStars" aria-hidden="true">
                  <!-- estrellas generadas dinámicamente -->
                </div>
                <div class="rating-caption small text-muted mt-1">Valoración media de tus recetas</div>
                <div id="perfilValoracionCount" class="rating-count small text-muted mt-1">&nbsp;</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="card mt-3 shadow-sm">
            <div class="card-body">
              <h4 class="card-title">Recetas</h4>
              <p class="card-text">Aquí puedes ver algunos datos de tu cuenta.</p>

              <div class="row text-center mt-4 gx-3">
                <!-- Interactive stat tiles -->
                <div class="col-12">
                  <div class="d-flex gap-3 flex-wrap justify-content-center recetas-stats">
                    <button id="tilePropias" class="stat-tile btn shadow-sm propias" type="button" title="Ver mis recetas publicadas">
                      <div class="stat-icon bg-light rounded-circle"><i class="bi bi-journal-bookmark-fill text-primary"></i></div>
                      <div>
                        <div class="stat-number fw-bold" id="countPropias">0</div>
                        <div class="stat-label small text-muted">Recetas publicadas</div>
                      </div>
                    </button>

                    <button id="tileHechas" class="stat-tile btn shadow-sm hechas" type="button" title="Recetas que has marcado como hechas">
                      <div class="stat-icon bg-light rounded-circle"><i class="bi bi-check2-square text-success"></i></div>
                      <div>
                        <div class="stat-number fw-bold" id="countHechas">0</div>
                        <div class="stat-label small text-muted">Recetas hechas</div>
                      </div>
                    </button>

                    <button id="tileGuardadas" class="stat-tile btn shadow-sm guardadas" type="button" title="Recetas que has guardado">
                      <div class="stat-icon bg-light rounded-circle"><i class="bi bi-bookmark-check-fill text-warning"></i></div>
                      <div>
                        <div class="stat-number fw-bold" id="countGuardadas">0</div>
                        <div class="stat-label small text-muted">Recetas guardadas</div>
                      </div>
                    </button>
                  </div>
                </div>

                <!-- Preview de últimas recetas -->
                <div class="col-12 mt-3">
                  <div class="recetas-preview d-flex gap-2 justify-content-center flex-wrap" id="recetasPreview">
                    <!-- thumbnails cargadas dinámicamente -->
                  </div>
                    <div class="text-center mt-2">
                    <a id="btnVerTodasRecetas" href="/mis-recetas" class="btn btn-sm btn-outline-primary" role="button" aria-label="Ver todas mis recetas">Ver todas mis recetas</a>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light border-top mt-auto">
      <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <img src="/static/cocinero.png" alt="Logo" style="height: 16px;" class="me-2">
            <span class="text-muted small">Saborea</span>
          </div>
          <div class="text-muted small">© 2025 • ISO 2025/2026</div>
        </div>
      </div>
    </footer>

    <!-- Modal de Cerrar Sesión -->
    <div
      class="modal fade"
      id="cerrarSesionModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cerrarSesionModalLabel">
              Cerrar Sesión
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Contenedor para mensajes -->
            <div id="mensajeContainer" class="alert" style="display: none"></div>
            <form id="cerrarSesionForm" action="/cerrar-sesion" method="POST">
              <div id="mensajeCerrarSesion" class="alert alert-warning">
                ¿Estás seguro de querer cerrar sesión?
              </div>
            </form>
          </div>
          <div class="modal-footer" id="modalFooter">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="cerrarSesionForm"
              class="btn btn-primary"
            >
              Cerrar Sesión
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Cambiar Nombre de Usuario -->
    <div class="modal fade" id="cambiarNombreModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cambio nombre usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <label for="modalInputNombre" class="form-label">Nuevo nombre de usuario</label>
            <input id="modalInputNombre" type="text" class="form-control" placeholder="Introduce el nuevo nombre de usuario" required>
            <div id="modalMensajeNombre" style="display:none" class="mt-2"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="modalGuardarNombre" type="button" class="btn btn-primary">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Cambiar Foto de Perfil -->
    <div class="modal fade" id="cambiarFotoModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cambio foto perfil</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <label for="modalInputFoto" class="form-label">Selecciona una imagen</label>
            <input id="modalInputFoto" type="file" class="form-control" accept="image/*" required>
            <div id="modalMensajeFoto" style="display:none" class="mt-2"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="modalGuardarFoto" type="button" class="btn btn-primary">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Confirmar salida sin guardar (cuando hay cambios en modo edición) -->
    <div class="modal fade" id="confirmSalirModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Salir sin guardar</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p>Estás en modo edición y hay cambios sin guardar. ¿Seguro que quieres salir y perder los cambios?</p>
          </div>
          <div class="modal-footer">
            <button id="cancelSalirBtn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="confirmSalirBtn" type="button" class="btn btn-danger">Salir y descartar</button>
          </div>
        </div>
      </div>
    </div>

        <!-- Modal Editar Perfil (centralizado) -->
        <div class="modal fade" id="perfilEditModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Editar perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body">
                <div id="modalPerfilMensaje" style="display:none"></div>

                <div class="mb-3 text-center">
                  <img id="modalPerfilImagenPreview" src="/static/cocinero.png" alt="preview" class="rounded-circle" style="width:180px;height:180px;object-fit:cover;">
                </div>

                <div class="mb-3">
                  <label for="modalPerfilNombreInput" class="form-label">Nombre de usuario</label>
                  <input id="modalPerfilNombreInput" type="text" class="form-control" placeholder="Tu nombre de usuario" required>
                </div>

                <div class="mb-3">
                  <label for="modalPerfilFotoInput" class="form-label">Foto de perfil (opcional)</label>
                  <input id="modalPerfilFotoInput" type="file" class="form-control" accept="image/*">
                  <div class="mt-2 d-flex justify-content-center">
                    <button id="modalPerfilQuitarFoto" type="button" class="btn btn-outline-danger btn-sm">Quitar foto</button>
                  </div>
                </div>

                <!-- Sección para cambiar contraseña dentro del modal de perfil -->
                <div class="mt-3">
                  <button id="toggleCambiarPassBtn" type="button" class="btn btn-outline-secondary btn-sm">Cambiar contraseña</button>
                  <div id="passwordSection" style="display:none; margin-top:12px;">
                    <div class="mb-2">
                      <label for="modalPerfilPassActual" class="form-label">Contraseña actual</label>
                      <input id="modalPerfilPassActual" type="password" class="form-control" placeholder="Contraseña actual">
                    </div>
                    <div class="mb-2">
                      <label for="modalPerfilPassNueva" class="form-label">Nueva contraseña</label>
                      <input id="modalPerfilPassNueva" type="password" class="form-control" placeholder="Nueva contraseña">
                    </div>
                    <div class="mb-2">
                      <label for="modalPerfilPassConfirm" class="form-label">Confirmar nueva contraseña</label>
                      <input id="modalPerfilPassConfirm" type="password" class="form-control" placeholder="Confirma la nueva contraseña">
                    </div>
                    <div id="modalPerfilMensajePassword" style="display:none" class="mt-2"></div>
                    <div class="d-flex justify-content-end mt-2">
                      <button id="modalPerfilGuardarPassword" type="button" class="btn btn-warning">Cambiar contraseña</button>
                    </div>
                  </div>
                </div>

                <!-- Modal: Mis Recetas (lista) -->
                <div class="modal fade" id="misRecetasModal" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Mis recetas</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                      </div>
                      <div class="modal-body">
                        <div id="misRecetasList" class="list-group list-group-flush">
                          <!-- elementos llenados dinámicamente -->
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <a id="irAMisRecetas" href="/mis-recetas" class="btn btn-primary">Ir a Mis Recetas</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button id="modalPerfilGuardar" type="button" class="btn btn-primary">Guardar cambios</button>
              </div>
            </div>
          </div>
        </div>

        

        <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script para dropdowns en hover -->
    <script>
      document
        .querySelectorAll(".nav-item.dropdown")
        .forEach(function (dropdown) {
          const toggle = dropdown.querySelector('[data-bs-toggle="dropdown"]');
          if (toggle) {
            const dd = new bootstrap.Dropdown(toggle, {
              popperConfig: { strategy: "fixed" },
            });

            dropdown.addEventListener("mouseenter", () => dd.show());
            dropdown.addEventListener("mouseleave", () => dd.hide());
          }
        });
    </script>

    <!-- JavaScript de la aplicación -->
    <script type="module" src="/static/js/main.js"></script>
    <script type="module" src="/static/js/perfil.js"></script>
  </body>
</html>
