<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- Meta tags b√°sicos -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Recetas Guardadas - Proyecto Ingenier√≠a del Software</title>
    <meta
      name="description"
      content="Tus recetas guardadas - Proyecto web para la asignatura de Ingenier√≠a del Software - Universidad 2025/2026"
    />
    <meta
      name="keywords"
      content="ingenier√≠a software, proyecto web, fastapi, html, css, javascript, recetas guardadas"
    />
    <meta name="author" content="Victor Vega Martinez" />

    <!-- Pre-conect google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Allura&display=swap" rel="stylesheet">

    <!-- CSS personalizado -->
    <link rel="stylesheet" href="/static/saborea.css">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/cocinero.png">
  </head>
  <body class="bg-light d-flex flex-column min-vh-100">
    <!-- Estilos personalizados para tema naranja -->
    <style>
      /* Los estilos se heredan de saborea.css que usa --bs-primary (naranja) */
    </style>
    
    <!-- Navegaci√≥n principal -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">
          <span class="lh-1" style="font-family:'Allura',cursive; font-size:2.8rem;">Saborea</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Inicio</a>
            </li>

            <li class="nav-item dropdown d-flex align-items-center">
              <a class="nav-link active" href="/recetas">Recetas</a>
              <a
                class="nav-link dropdown-toggle dropdown-toggle-split px-1"
                href="#"
                id="navbarRecetas"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="M√°s opciones de Recetas"
              >
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end bg-primary bg-opacity-75 border-0 rounded-3 shadow py-2"
                aria-labelledby="navbarRecetas"
              >
                <li><a class="nav-link" href="/mis-recetas">Mis Recetas</a></li>
                <li>
                  <a class="nav-link active" href="/recetas-guardadas"
                    >Recetas Guardadas</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/menu-semanal">Men√∫ Semanal</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/comunidad">Comunidad</a>
            </li>
          </ul>

          <span class="navbar-text text-light me-3">
            <a
              class="bi bi-person-circle nav-link"
              href="/perfil"
              style="text-decoration: none"
            >
              <i>Perfil</i>
            </a>
          </span>

          <button
            type="button"
            class="btn btn-outline-light ms-2"
            data-bs-toggle="modal"
            data-bs-target="#cerrarSesionModal"
          >
            <i class="bi bi-box-arrow-in-left"></i> Cerrar Sesi√≥n
          </button>
        </div>
      </div>
    </nav>

    <!-- Contenido principal -->
    <main class="flex-grow-1">
      <div class="container-fluid mt-3 pt-2 px-4">
        <!-- Secci√≥n de recetas guardadas -->
        <div class="row justify-content-center">
          <div class="col-12 col-md-11 col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="fw-bold mb-0">
                <i class="bi bi-bookmark-heart-fill text-primary"></i> Mis Recetas Guardadas
              </h4>
            </div>

            <!-- Mensaje de estado -->
            <div id="mensajeEstado" class="mb-4" style="display: none">
              <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle"></i>
                <span id="textoMensajeEstado">Cargando recetas guardadas...</span>
              </div>
            </div>

            <!-- Contenedor de recetas -->
            <div class="row g-4" id="contenedorRecetas">
              <!-- Las recetas se cargar√°n din√°micamente aqu√≠ -->
            </div>

            <!-- Mensaje cuando no hay recetas -->
            <div id="mensajeSinRecetas" style="display: none">
              <div class="text-center py-5">
                <i class="bi bi-bookmark text-muted" style="font-size: 4rem"></i>
                <h3 class="text-muted mt-3">No tienes recetas guardadas</h3>
                <p class="text-muted mb-4">
                  Explora la secci√≥n de comunidad y guarda las recetas que m√°s te gusten
                </p>
                <a href="/comunidad" class="btn btn-primary btn-lg">
                  <i class="bi bi-search"></i> Explorar Recetas
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light border-top mt-auto">
      <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <img src="/static/cocinero.png" alt="Logo" style="height: 16px;" class="me-2">
            <span class="text-muted small">Saborea</span>
          </div>
          <div class="text-muted small">¬© 2025 ‚Ä¢ ISO 2025/2026</div>
        </div>
      </div>
    </footer>

    <!-- Modal de Cerrar Sesi√≥n -->
    <div
      class="modal fade"
      id="cerrarSesionModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cerrarSesionModalLabel">
              Cerrar Sesi√≥n
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Contenedor para mensajes -->
            <div
              id="mensajeContainer"
              class="alert"
              style="display: none"
            ></div>
            <form id="cerrarSesionForm" action="/cerrar-sesion" method="POST">
              <div id="mensajeCerrarSesion" class="alert alert-warning">
                ¬øEst√°s seguro de querer cerrar sesi√≥n?
              </div>
            </form>
          </div>
          <div class="modal-footer" id="modalFooter">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="cerrarSesionForm"
              class="btn btn-primary"
            >
              Cerrar Sesi√≥n
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Detalle de Receta -->
    <div
      class="modal fade"
      id="detalleRecetaModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
    >
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detalleRecetaModalLabel">
              <i class="bi bi-book text-primary me-2"></i>
              <span id="tituloRecetaDetalle">Cargando...</span>
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Loading spinner -->
            <div id="loadingDetalleReceta" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando detalles de la receta...</span>
              </div>
              <p class="mt-2 text-muted">Cargando informaci√≥n completa...</p>
            </div>
            
            <!-- Contenido de la receta -->
            <div id="contenidoDetalleReceta" style="display: none;">
              <div class="row">
                <!-- Columna izquierda: Imagen y datos b√°sicos -->
                <div class="col-lg-5">
                  <div class="card border-0 shadow-sm mb-4">
                    <div id="imagenRecetaDetalle" class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 300px;">
                      <!-- La imagen se cargar√° aqu√≠ -->
                    </div>
                    <div class="card-body">
                      <div class="row g-3">
                        <div class="col-6">
                          <div class="bg-primary bg-opacity-10 rounded p-3 text-center">
                            <i class="bi bi-clock text-primary fs-4"></i>
                            <div class="mt-2">
                              <small class="text-muted d-block">Duraci√≥n</small>
                              <strong id="duracionRecetaDetalle">-</strong>
                            </div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="bg-warning bg-opacity-10 rounded p-3 text-center">
                            <i class="bi bi-star text-warning fs-4"></i>
                            <div class="mt-2">
                              <small class="text-muted d-block">Dificultad</small>
                              <strong id="dificultadRecetaDetalle">-</strong>
                            </div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="bg-success bg-opacity-10 rounded p-3 text-center">
                            <i class="bi bi-geo-alt text-success fs-4"></i>
                            <div class="mt-2">
                              <small class="text-muted d-block">Pa√≠s origen</small>
                              <strong id="paisOrigenRecetaDetalle">-</strong>
                            </div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="bg-info bg-opacity-10 rounded p-3 text-center">
                            <i class="bi bi-clock-history text-info fs-4"></i>
                            <div class="mt-2">
                              <small class="text-muted d-block">Turno comida</small>
                              <strong id="turnoComidaRecetaDetalle">-</strong>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Secci√≥n de Valoraci√≥n -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-warning bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        Valoraci√≥n
                      </h6>
                    </div>
                    <div class="card-body">
                      <!-- Valoraci√≥n Media -->
                      <div class="text-center mb-3">
                        <div class="d-flex justify-content-center align-items-center mb-2">
                          <div id="estrellaMediaReceta" class="fs-4">
                            <!-- Estrellas de valoraci√≥n media -->
                          </div>
                          <span class="ms-3 fs-5 fw-bold" id="valoracionMediaNumero">0.0</span>
                        </div>
                        <small class="text-muted" id="totalValoracionesTexto">Sin valoraciones</small>
                      </div>
                      
                      <hr class="my-3">
                      
                      <!-- Valorar esta receta -->
                      <div class="text-center">
                        <div class="form-label fw-bold mb-2">
                          <i class="bi bi-hand-thumbs-up me-1"></i>
                          Tu valoraci√≥n
                        </div>
                        <div id="estrellaValoracionUsuario" class="fs-3" style="cursor: pointer;">
                          <i class="bi bi-star estrella-valoracion" data-valor="1"></i>
                          <i class="bi bi-star estrella-valoracion" data-valor="2"></i>
                          <i class="bi bi-star estrella-valoracion" data-valor="3"></i>
                          <i class="bi bi-star estrella-valoracion" data-valor="4"></i>
                          <i class="bi bi-star estrella-valoracion" data-valor="5"></i>
                        </div>
                        <small class="text-muted d-block mt-2" id="mensajeValoracion">Haz clic en una estrella para valorar</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Columna derecha: Descripci√≥n, ingredientes e instrucciones -->
                <div class="col-lg-7">
                  <!-- Descripci√≥n -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-primary bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-file-text text-primary me-2"></i>
                        Descripci√≥n
                      </h6>
                    </div>
                    <div class="card-body">
                      <p id="descripcionRecetaDetalle" class="mb-0">-</p>
                    </div>
                  </div>
                  
                  <!-- Ingredientes -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-success bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-list-check text-success me-2"></i>
                        Ingredientes
                      </h6>
                    </div>
                    <div class="card-body">
                      <div id="ingredientesRecetaDetalle">
                        <p class="text-muted mb-0">No se han especificado ingredientes.</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Instrucciones -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-warning bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-list-ol text-warning me-2"></i>
                        Pasos a seguir
                      </h6>
                    </div>
                    <div class="card-body">
                      <div id="instruccionesRecetaDetalle">
                        <p class="text-muted mb-0">No se han especificado pasos a seguir.</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Al√©rgenos -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-danger bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                        Al√©rgenos
                      </h6>
                    </div>
                    <div class="card-body">
                      <div id="alergenosRecetaDetalle">
                        <p class="text-muted mb-0">No se han especificado al√©rgenos.</p>
                      </div>
                    </div>
                  </div>

                  <!-- Secci√≥n de Comentarios -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-info bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-chat-dots text-info me-2"></i>
                        Comentarios
                        <span class="badge bg-info ms-2" id="contadorComentarios">0</span>
                      </h6>
                    </div>
                    <div class="card-body">
                      <!-- Formulario para a√±adir comentario -->
                      <div class="mb-4">
                        <label for="nuevoComentarioTexto" class="form-label fw-bold">
                          <i class="bi bi-pencil-square me-1"></i>
                          A√±adir un comentario
                        </label>
                        <textarea
                          class="form-control"
                          id="nuevoComentarioTexto"
                          rows="3"
                          maxlength="500"
                          placeholder="Escribe tu comentario aqu√≠... (m√°ximo 500 caracteres)"
                        ></textarea>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                          <small class="text-muted">
                            <span id="contadorCaracteres">0</span>/500 caracteres
                          </small>
                          <div>
                            <button
                              type="button"
                              class="btn btn-sm btn-outline-secondary me-2"
                              id="cancelarComentarioBtn"
                            >
                              <i class="bi bi-x-circle me-1"></i>
                              Cancelar
                            </button>
                            <button
                              type="button"
                              class="btn btn-sm btn-primary"
                              id="publicarComentarioBtn"
                            >
                              <i class="bi bi-send me-1"></i>
                              Publicar
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- Lista de comentarios -->
                      <div id="listaComentarios">
                        <p class="text-muted text-center py-3">
                          <i class="bi bi-chat-quote"></i>
                          No hay comentarios a√∫n. ¬°S√© el primero en comentar!
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Error state -->
            <div id="errorDetalleReceta" style="display: none;" class="text-center py-5">
              <div class="text-danger">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Error al cargar la receta</h5>
                <p id="mensajeErrorDetalle">Ha ocurrido un error inesperado</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-danger me-auto"
              id="eliminarRecetaBtn"
              style="display: none;"
            >
              <i class="bi bi-trash me-1"></i>
              Eliminar
            </button>
            <button
              type="button"
              class="btn btn-warning"
              id="guardarRecetaBtn"
            >
              <i class="bi bi-bookmark-plus me-1"></i>
              Guardar
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              <i class="bi bi-x-circle me-1"></i>
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de confirmaci√≥n de eliminaci√≥n -->
    <div class="modal fade" id="confirmarEliminarModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar eliminaci√≥n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p>¬øEst√°s seguro de que quieres eliminar esta receta? Esta acci√≥n no se puede deshacer y la receta desaparecer√° para todos los usuarios.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmarEliminarBtn">Eliminar receta</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script para dropdowns en hover -->
    <script>
      document
        .querySelectorAll(".nav-item.dropdown")
        .forEach(function (dropdown) {
          const toggle = dropdown.querySelector('[data-bs-toggle="dropdown"]');
          const dd = new bootstrap.Dropdown(toggle, {
            popperConfig: { strategy: "fixed" },
          });

          dropdown.addEventListener("mouseenter", () => dd.show());
          dropdown.addEventListener("mouseleave", () => dd.hide());
        });
    </script>
    
    <!-- Scripts de la aplicaci√≥n -->
    <script type="module" src="/static/js/main.js"></script>
    <script type="module">
      // Script espec√≠fico para recetas guardadas
      import {
        cargarRecetasGuardadas,
        desguardarReceta,
        eliminarReceta,
      } from "/static/js/services/api-service.js";
      import { mostrarMensaje } from "/static/js/components/message-handler.js";
      import {
        formatearDuracion,
        crearCardReceta,
        agregarEventListenersRecetas,
        mostrarLoadingModal,
        mostrarErrorModal,
        obtenerDetalleReceta,
        mostrarIngredientes,
        mostrarPasosAseguir,
        mostrarAlergenos,
        mostrarImagenReceta
      } from "/static/js/utils/recetas-utils.js";

      // Cargar recetas guardadas al cargar la p√°gina
      // Wrapper para consumir/suprimir flashes r√°pidos heredados
      // Si existe la bandera `suppressNextFlash` la consumimos aqu√≠ antes
      // de permitir que se muestren mensajes desde este archivo.
      function mostrarMensajeGuardado(mensaje, tipo = "info", duracion = 5000) {
        try {
          if (typeof window !== 'undefined' && window.sessionStorage) {
            const suppressed = window.sessionStorage.getItem('suppressNextFlash');
            if (suppressed === '1') {
              // Consumir la bandera y no mostrar el mensaje
              window.sessionStorage.removeItem('suppressNextFlash');
              return;
            }
          }
        } catch (e) {
          // ignore storage errors
        }
        // Llamar al mostrarMensaje importado
        try { mostrarMensaje(mensaje, tipo, duracion); } catch(e) { console.error(e); }
      }

      document.addEventListener("DOMContentLoaded", async function () {
        await cargarYMostrarRecetasGuardadas();
      });

      /**
       * Abre el modal de detalle de una receta
       * @param {string} recetaId - ID de la receta a mostrar
       */
      async function abrirModalDetalleReceta(recetaId) {
        const detalleModalEl = document.getElementById('detalleRecetaModal');
        const modal = detalleModalEl ? new bootstrap.Modal(detalleModalEl) : null;
        
        // Mostrar modal con loading
        try { mostrarLoadingModal(); } catch (e) {}
        if (modal) modal.show();
        
        try {
          const resultado = await obtenerDetalleReceta(recetaId);
          
          if (resultado.exito && resultado.receta) {
            // Pasar tambi√©n el email del usuario actual (resultado.usuario) para controlar permisos
            mostrarDetalleReceta(resultado.receta, resultado.usuario);
          } else {
            mostrarErrorModal(resultado.mensaje || "No se pudo cargar la receta");
          }
        } catch (error) {
          mostrarErrorModal(error.message);
        }
      }

      /**
       * Muestra el detalle completo de una receta en el modal
       * @param {Object} receta - Objeto con los datos de la receta
       */
      function mostrarDetalleReceta(receta, emailUsuario) {
        // Ocultar loading y error, mostrar contenido
        document.getElementById('loadingDetalleReceta').style.display = 'none';
        document.getElementById('errorDetalleReceta').style.display = 'none';
        document.getElementById('contenidoDetalleReceta').style.display = 'block';

        // Llenar datos b√°sicos
        document.getElementById('tituloRecetaDetalle').textContent = receta.nombreReceta || 'Sin nombre';
        
        // Agregar atributos de datos para referencia
        const tituloElement = document.getElementById('tituloRecetaDetalle');
        tituloElement.setAttribute('data-receta-nombre', receta.nombreReceta);
        tituloElement.setAttribute('data-receta-id', receta.id || '');
        
        document.getElementById('descripcionRecetaDetalle').textContent = receta.descripcion || 'Sin descripci√≥n';
        document.getElementById('duracionRecetaDetalle').textContent = formatearDuracion(receta.duracion || 0);
        document.getElementById('dificultadRecetaDetalle').textContent = receta.dificultad || 'No especificada';
        document.getElementById('paisOrigenRecetaDetalle').textContent = receta.paisOrigen || 'No especificado';
        
        // Formatear turno de comida
        const turnoComida = receta.turnoComida || 'No especificado';
        document.getElementById('turnoComidaRecetaDetalle').textContent = 
          turnoComida.charAt(0).toUpperCase() + turnoComida.slice(1).toLowerCase();

        // Mostrar imagen
        mostrarImagenReceta(
          receta.fotoReceta,
          receta.nombreReceta,
          document.getElementById('imagenRecetaDetalle')
        );

        // Mostrar ingredientes
        mostrarIngredientes(
          receta.ingredientes,
          document.getElementById('ingredientesRecetaDetalle')
        );

        // Mostrar pasos a seguir
        mostrarPasosAseguir(
          receta.pasosAseguir,
          document.getElementById('instruccionesRecetaDetalle')
        );

        // Mostrar al√©rgenos
        mostrarAlergenos(
          receta.alergenos,
          document.getElementById('alergenosRecetaDetalle')
        );

        // Configurar bot√≥n de desguardar (siempre estar√° guardada en esta p√°gina)
        configurarBotonDesguardar(receta);

        // Configurar bot√≥n de eliminar solo si el usuario actual es el autor
        configurarBotonEliminar(receta, emailUsuario);
        
        // Guardar ID y nombre de receta para comentarios
        window.recetaActualNombre = receta.nombreReceta;
        window.recetaActualId = receta.id;
        
        // Cargar comentarios y valoraciones
        if (receta.id) {
          cargarComentarios(receta.id);
          cargarValoraciones(receta.id, receta.nombreReceta);
        }
      }

      /**
       * Configura el bot√≥n de eliminar receta (mostrar/ocultar y evento)
       * @param {Object} receta
       * @param {string} emailUsuario - email del usuario autenticado
       */
      function configurarBotonEliminar(receta, emailUsuario) {
        const btnEliminar = document.getElementById('eliminarRecetaBtn');
        if (!btnEliminar) return;

        // Mostrar el bot√≥n solo si el usuario autenticado es el autor de la receta
          if (emailUsuario && receta.usuario && emailUsuario === receta.usuario) {
          btnEliminar.style.display = 'inline-block';
          btnEliminar.disabled = false;

          // Al pulsar el bot√≥n, abrir modal de confirmaci√≥n
          btnEliminar.onclick = function() {
            const confirmarEl = document.getElementById('confirmarEliminarModal');
            const confirmarModal = confirmarEl ? new bootstrap.Modal(confirmarEl) : null;
            // Guardar el nombre de la receta a eliminar en un atributo data
            const confirmarBtn = document.getElementById('confirmarEliminarBtn');
            if (confirmarBtn) confirmarBtn.setAttribute('data-nombre-receta', receta.nombreReceta);
            if (confirmarModal) confirmarModal.show();
          };
        } else {
          btnEliminar.style.display = 'none';
        }
      }

      // Manejar confirmaci√≥n del modal de eliminaci√≥n
      document.addEventListener('DOMContentLoaded', function() {
        const confirmarBtn = document.getElementById('confirmarEliminarBtn');
        if (confirmarBtn) {
          confirmarBtn.addEventListener('click', async function() {
            const nombreReceta = this.getAttribute('data-nombre-receta');
            // Deshabilitar mientras se procesa
            this.disabled = true;
            try {
              // Llamar al endpoint de eliminaci√≥n
              const resultado = await eliminarReceta(nombreReceta);

              // Cerrar modal de detalle y confirmaci√≥n
              const detalleModalEl = document.getElementById('detalleRecetaModal');
                try { if (detalleModalEl) { const inst = bootstrap.Modal.getInstance(detalleModalEl); if (inst) inst.hide(); } } catch (e) {}
                const confirmarModalEl = document.getElementById('confirmarEliminarModal');
                try { if (confirmarModalEl) { const inst2 = bootstrap.Modal.getInstance(confirmarModalEl); if (inst2) inst2.hide(); } } catch (e) {}

              if (resultado && resultado.success) {
                mostrarMensajeGuardado(`Receta "${nombreReceta}" eliminada correctamente`, 'success');
                // Recargar lista de recetas guardadas
                await cargarYMostrarRecetasGuardadas();
              } else {
                mostrarMensajeGuardado(resultado.data?.mensaje || 'No se pudo eliminar la receta', 'error');
                this.disabled = false;
              }
              } catch (err) {
              console.error('Error al eliminar receta:', err);
              mostrarMensajeGuardado('Error al eliminar la receta', 'error');
              this.disabled = false;
            }
          });
        }
      });

      /**
       * Configura el bot√≥n de desguardar receta
       * @param {Object} receta - Objeto con los datos de la receta
       */
      function configurarBotonDesguardar(receta) {
        const btnGuardar = document.getElementById('guardarRecetaBtn');
        if (!btnGuardar) return;

        // En recetas guardadas, el bot√≥n siempre permite desguardar
        btnGuardar.innerHTML = '<i class="bi bi-bookmark-check-fill"></i> Guardada';
        btnGuardar.className = 'btn btn-success';
        btnGuardar.disabled = false;
        
        // Configurar el evento click para desguardar
        btnGuardar.onclick = async function() {
          await desguardarRecetaYActualizar(receta.nombreReceta, btnGuardar);
        };
      }

      /**
       * Desguarda una receta y actualiza la lista
       * @param {string} nombreReceta - Nombre de la receta a desguardar
       * @param {HTMLElement} boton - Elemento del bot√≥n
       */
      async function desguardarRecetaYActualizar(nombreReceta, boton) {
        try {
          // Deshabilitar el bot√≥n mientras se procesa
          boton.disabled = true;
          
          const response = await fetch("/desguardar-receta", {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ nombreReceta: nombreReceta }),
          });

          const resultado = await response.json();

          if (resultado.exito) {
            // Cerrar el modal (guardado)
            try { const detEl = document.getElementById('detalleRecetaModal'); if (detEl) { const inst = bootstrap.Modal.getInstance(detEl); if (inst) inst.hide(); } } catch (e) {}
            
            // Mostrar mensaje de √©xito
            mostrarMensajeGuardado(`Receta "${nombreReceta}" desguardada correctamente`, "success");
            
            // Recargar las recetas guardadas
            await cargarYMostrarRecetasGuardadas();
            } else {
            mostrarMensajeGuardado(resultado.mensaje || "No se pudo desguardar la receta", "error");
            boton.disabled = false;
          }
          } catch (error) {
          console.error("Error al desguardar receta:", error);
          mostrarMensajeGuardado("Error al desguardar la receta", "error");
          boton.disabled = false;
        }
      }

      // Cargar recetas guardadas al cargar la p√°gina
      document.addEventListener("DOMContentLoaded", async function () {
        await cargarYMostrarRecetasGuardadas();
      });

      /**
       * Configura los botones de desguardar en las cards de recetas guardadas
       */
      function configurarBotonesDesguardarCards() {
        const botones = document.querySelectorAll('.btn-guardar-card');
        
        botones.forEach((boton) => {
          const nombreReceta = boton.getAttribute('data-receta-nombre');
          
          // En recetas guardadas, todas est√°n guardadas (mostrar icono lleno)
          actualizarEstadoBotonCard(boton, true);
          
          // A√±adir evento click para desguardar
          boton.addEventListener('click', async (e) => {
            e.stopPropagation(); // Evitar que se abra el modal
            await desguardarRecetaCard(nombreReceta, boton);
          });
        });
      }

      /**
       * Desguarda una receta desde el bot√≥n en la card
       * @param {string} nombreReceta - Nombre de la receta a desguardar
       * @param {HTMLElement} boton - Elemento del bot√≥n
       */
      async function desguardarRecetaCard(nombreReceta, boton) {
        try {
          // Deshabilitar el bot√≥n mientras se procesa
          boton.disabled = true;
          
          const response = await fetch("/desguardar-receta", {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ nombreReceta: nombreReceta }),
          });

          const resultado = await response.json();

          if (resultado.exito) {
            console.log(`üóëÔ∏è Receta "${nombreReceta}" desguardada desde la card`);
            
            // Mostrar mensaje de √©xito
            mostrarMensajeGuardado(`Receta "${nombreReceta}" desguardada correctamente`, "success");
            
            // Recargar las recetas guardadas (eliminar√° la card de la vista)
            await cargarYMostrarRecetasGuardadas();
          } else {
            mostrarMensajeGuardado(resultado.mensaje || "No se pudo desguardar la receta", "error");
            boton.disabled = false;
          }
        } catch (error) {
          console.error("Error al desguardar receta:", error);
          mostrarMensajeGuardado("Error al desguardar la receta", "error");
          boton.disabled = false;
        }
      }

      /**
       * Actualiza el aspecto del bot√≥n en la card seg√∫n el estado de guardado
       * @param {HTMLElement} boton - Elemento del bot√≥n
       * @param {boolean} estaGuardada - true si la receta est√° guardada
       */
      function actualizarEstadoBotonCard(boton, estaGuardada) {
        if (estaGuardada) {
          // Estado: Ya guardada (bookmark lleno, amarillo/dorado)
          boton.innerHTML = '<i class="bi bi-bookmark-fill fs-5 text-warning"></i>';
          boton.className = 'btn btn-light btn-sm position-absolute top-0 end-0 m-2 rounded-circle d-flex align-items-center justify-content-center btn-guardar-card shadow-sm';
          boton.setAttribute('data-guardada', 'true');
          boton.title = 'Quitar de guardados';
        } else {
          // Estado: No guardada (bookmark vac√≠o)
          boton.innerHTML = '<i class="bi bi-bookmark fs-5"></i>';
          boton.className = 'btn btn-light btn-sm position-absolute top-0 end-0 m-2 rounded-circle d-flex align-items-center justify-content-center btn-guardar-card shadow-sm';
          boton.setAttribute('data-guardada', 'false');
          boton.title = 'Guardar receta';
        }
        boton.disabled = false;
      }

      async function cargarYMostrarRecetasGuardadas() {
        const mensajeEstado = document.getElementById("mensajeEstado");
        const contenedorRecetas = document.getElementById("contenedorRecetas");
        const mensajeSinRecetas = document.getElementById("mensajeSinRecetas");

        // Mostrar el mensaje de carga SOLO si la operaci√≥n tarda m√°s de 250ms.
        // Esto evita que el texto "Cargando tus recetas guardadas..." parpadee
        // en navegaciones r√°pidas donde los datos llegan inmediatamente.
        let loadingTimer = null;
        try {
          loadingTimer = setTimeout(() => {
            try {
              mensajeEstado.style.display = "block";
              document.getElementById("textoMensajeEstado").textContent =
                "Cargando tus recetas guardadas...";
            } catch (e) {
              // ignore DOM errors
            }
          }, 250);

          // Cargar recetas guardadas
          const resultado = await cargarRecetasGuardadas();

          // Ocultar mensaje de estado (si se mostr√≥)
          if (loadingTimer) { clearTimeout(loadingTimer); loadingTimer = null; }
          try { mensajeEstado.style.display = "none"; } catch (e) {}

          if (resultado.success && resultado.data.recetas) {
            const recetas = resultado.data.recetas;

            if (recetas.length === 0) {
              // No hay recetas guardadas
              mensajeSinRecetas.style.display = "block";
              contenedorRecetas.innerHTML = "";
            } else {
              // Mostrar recetas usando la funci√≥n compartida
              mensajeSinRecetas.style.display = "none";
              contenedorRecetas.innerHTML = recetas.map(receta => crearCardReceta(receta, true)).join("");
              
              // Agregar event listeners a las tarjetas de recetas
              agregarEventListenersRecetas(abrirModalDetalleReceta);
              
              // Configurar botones de desguardar en las cards
              configurarBotonesDesguardarCards();
            }
          } else {
            throw new Error(
              resultado.data?.mensaje || "Error al cargar recetas guardadas"
            );
          }
        } catch (error) {
          console.error("Error al cargar recetas guardadas:", error);
          mensajeEstado.style.display = "none";
            mostrarMensajeGuardado(
            `Error al cargar recetas guardadas: ${error.message}`,
            "error"
          );

          // Mostrar mensaje de error
          contenedorRecetas.innerHTML = `
            <div class="col-12">
              <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle"></i>
                Error al cargar las recetas guardadas. Por favor, intenta de nuevo m√°s tarde.
              </div>
            </div>
          `;
        }
      }

      // Hacer funci√≥n global para uso en otros lugares
      window.cargarYMostrarRecetasGuardadas = cargarYMostrarRecetasGuardadas;

      /**
       * Carga y muestra los comentarios de una receta
       * @param {string} recetaId - ID de la receta
       */
      async function cargarComentarios(recetaId) {
        try {
          const response = await fetch(`/api/comentarios-receta/${recetaId}`, {
            method: "GET",
            credentials: "include",
            headers: {
              Accept: "application/json",
              "Cache-Control": "no-cache",
            },
          });

          const resultado = await response.json();
          
          if (resultado.exito) {
            // Los comentarios vienen directamente en resultado, no en resultado.data
            const comentarios = resultado.comentarios || [];
            mostrarComentarios(comentarios);
            
            // Actualizar contador
            document.getElementById('contadorComentarios').textContent = comentarios.length;
          } else {
            console.error("Error al cargar comentarios:", resultado.mensaje);
          }
        } catch (error) {
          console.error("Error al cargar comentarios:", error);
        }
      }

      /**
       * Muestra la lista de comentarios en el modal
       * @param {Array} comentarios - Array de comentarios
       */
      function mostrarComentarios(comentarios) {
        const listaComentarios = document.getElementById('listaComentarios');
        
        if (!comentarios || comentarios.length === 0) {
          listaComentarios.innerHTML = `
            <p class="text-muted text-center py-3">
              <i class="bi bi-chat-quote"></i>
              No hay comentarios a√∫n. ¬°S√© el primero en comentar!
            </p>
          `;
          return;
        }
        
        // Ordenar comentarios por fecha (m√°s recientes primero)
        comentarios.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        
        listaComentarios.innerHTML = comentarios.map(comentario => {
          const fecha = new Date(comentario.fecha);
          const fechaFormateada = formatearFechaComentario(fecha);
          
          return `
            <div class="card mb-3 border-0 bg-light">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="mb-0 text-primary">
                    <i class="bi bi-person-circle me-1"></i>
                    ${comentario.nombreUsuario || 'Usuario'}
                  </h6>
                  <small class="text-muted">
                    <i class="bi bi-clock me-1"></i>
                    ${fechaFormateada}
                  </small>
                </div>
                <p class="mb-0">${escaparHTML(comentario.texto)}</p>
              </div>
            </div>
          `;
        }).join('');
      }

      /**
       * Formatea la fecha de un comentario de manera amigable
       * @param {Date} fecha - Fecha del comentario
       * @returns {string} Fecha formateada
       */
      function formatearFechaComentario(fecha) {
        const ahora = new Date();
        const diferencia = ahora - fecha;
        
        const segundos = Math.floor(diferencia / 1000);
        const minutos = Math.floor(segundos / 60);
        const horas = Math.floor(minutos / 60);
        const dias = Math.floor(horas / 24);
        
        if (segundos < 60) return 'Hace unos segundos';
        if (minutos < 60) return `Hace ${minutos} minuto${minutos !== 1 ? 's' : ''}`;
        if (horas < 24) return `Hace ${horas} hora${horas !== 1 ? 's' : ''}`;
        if (dias < 7) return `Hace ${dias} d√≠a${dias !== 1 ? 's' : ''}`;
        
        return fecha.toLocaleDateString('es-ES', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric' 
        });
      }

      /**
       * Escapa caracteres HTML para prevenir XSS
       * @param {string} texto - Texto a escapar
       * @returns {string} Texto escapado
       */
      function escaparHTML(texto) {
        const div = document.createElement('div');
        div.textContent = texto;
        return div.innerHTML;
      }

      /**
       * Publica un nuevo comentario en la receta
       */
      async function publicarComentario() {
        const textarea = document.getElementById('nuevoComentarioTexto');
        const texto = textarea.value.trim();
        
        if (!texto) {
          mostrarMensajeGuardado('Por favor, escribe un comentario antes de publicar.', 'warning');
          return;
        }
        
        if (!window.recetaActualNombre) {
          mostrarMensajeGuardado('Error: No se pudo identificar la receta.', 'error');
          return;
        }
        
        // Deshabilitar bot√≥n mientras se publica
        const btnPublicar = document.getElementById('publicarComentarioBtn');
        const textoOriginal = btnPublicar.innerHTML;
        btnPublicar.disabled = true;
        btnPublicar.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Publicando...';
        
        try {
          const response = await fetch('/api/comentar-receta', {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            body: JSON.stringify({
              nombreReceta: window.recetaActualNombre,
              texto: texto
            })
          });
          
          const resultado = await response.json();
          
          if (resultado.exito) {
            // Limpiar textarea
            textarea.value = '';
            document.getElementById('contadorCaracteres').textContent = '0';
            
            // Recargar comentarios usando el ID guardado
            if (window.recetaActualId) {
              await cargarComentarios(window.recetaActualId);
            }
            
            // Mostrar mensaje de √©xito
            mostrarMensajeGuardado('‚úÖ ¬°Comentario publicado correctamente!', 'success');
          } else {
            mostrarMensajeGuardado(`Error al publicar comentario: ${resultado.mensaje || 'Error desconocido'}`, 'error');
          }
        } catch (error) {
          console.error('Error al publicar comentario:', error);
          mostrarMensajeGuardado('Error de conexi√≥n. No se pudo publicar el comentario.', 'error');
        } finally {
          // Restaurar bot√≥n
          btnPublicar.disabled = false;
          btnPublicar.innerHTML = textoOriginal;
        }
      }

      /**
       * Cancela el comentario y limpia el textarea
       */
      function cancelarComentario() {
        const textarea = document.getElementById('nuevoComentarioTexto');
        textarea.value = '';
        document.getElementById('contadorCaracteres').textContent = '0';
      }

      /**
       * Actualiza el contador de caracteres del comentario
       */
      function actualizarContadorCaracteres() {
        const textarea = document.getElementById('nuevoComentarioTexto');
        const contador = document.getElementById('contadorCaracteres');
        contador.textContent = textarea.value.length;
      }

      // Inicializar eventos de comentarios
      document.addEventListener("DOMContentLoaded", function() {
        // Contador de caracteres
        const textarea = document.getElementById('nuevoComentarioTexto');
        if (textarea) {
          textarea.addEventListener('input', actualizarContadorCaracteres);
        }
        
        // Bot√≥n publicar comentario
        const btnPublicar = document.getElementById('publicarComentarioBtn');
        if (btnPublicar) {
          btnPublicar.addEventListener('click', publicarComentario);
        }
        
        // Bot√≥n cancelar comentario
        const btnCancelar = document.getElementById('cancelarComentarioBtn');
        if (btnCancelar) {
          btnCancelar.addEventListener('click', cancelarComentario);
        }
      });

      // ============================================
      // FUNCIONES DE VALORACI√ìN
      // ============================================

      /**
       * Carga las valoraciones de una receta
       * @param {string} recetaId - ID de la receta
       * @param {string} nombreReceta - Nombre de la receta
       */
      async function cargarValoraciones(recetaId, nombreReceta) {
        console.log(`‚≠ê Cargando valoraciones para receta ID: ${recetaId}`);
        window.recetaActualNombre = nombreReceta;
        
        try {
          const respuesta = await fetch(`/api/valoracion-receta/${recetaId}`, {
            method: 'GET',
            credentials: 'include'
          });
          
          const resultado = await respuesta.json();
          console.log('üìä Resultado de valoraciones:', resultado);
          
          if (resultado.exito) {
            mostrarValoraciones(resultado);
            configurarEstrellas(resultado.valoracionUsuario || 0);
          } else {
            console.error('‚ùå Error al cargar valoraciones:', resultado.mensaje);
          }
        } catch (error) {
          console.error('‚ùå Error al cargar valoraciones:', error);
        }
      }

      /**
       * Muestra las valoraciones en la interfaz
       * @param {Object} datos - Datos de las valoraciones
       */
      function mostrarValoraciones(datos) {
        const { valoracionMedia, totalValoraciones } = datos;
        
        // Mostrar valoraci√≥n media
        document.getElementById('valoracionMediaNumero').textContent = valoracionMedia.toFixed(1);
        
        // Mostrar estrellas de valoraci√≥n media
        const contenedorEstrellas = document.getElementById('estrellaMediaReceta');
        contenedorEstrellas.innerHTML = '';
        
        for (let i = 1; i <= 5; i++) {
          const estrella = document.createElement('i');
          if (i <= Math.floor(valoracionMedia)) {
            estrella.className = 'bi bi-star-fill text-warning';
          } else if (i === Math.ceil(valoracionMedia) && valoracionMedia % 1 !== 0) {
            estrella.className = 'bi bi-star-half text-warning';
          } else {
            estrella.className = 'bi bi-star text-warning';
          }
          contenedorEstrellas.appendChild(estrella);
        }
        
        // Mostrar total de valoraciones
        const textoValoraciones = totalValoraciones === 0 
          ? 'Sin valoraciones' 
          : totalValoraciones === 1 
            ? '1 valoraci√≥n' 
            : `${totalValoraciones} valoraciones`;
        document.getElementById('totalValoracionesTexto').textContent = textoValoraciones;
      }

      /**
       * Configura las estrellas interactivas para que el usuario valore
       * @param {number} valoracionActual - Valoraci√≥n actual del usuario (0-5)
       */
      function configurarEstrellas(valoracionActual) {
        const contenedor = document.getElementById('estrellaValoracionUsuario');
        const estrellas = document.querySelectorAll('.estrella-valoracion');
        
        // IMPORTANTE: Clonar el contenedor para eliminar todos los event listeners anteriores
        const nuevoContenedor = contenedor.cloneNode(true);
        contenedor.parentNode.replaceChild(nuevoContenedor, contenedor);
        
        // Obtener las nuevas estrellas del contenedor clonado
        const nuevasEstrellas = nuevoContenedor.querySelectorAll('.estrella-valoracion');
        
        // Marcar las estrellas seg√∫n la valoraci√≥n actual
        actualizarEstrellasVisuales(valoracionActual);
        
        // A√±adir eventos hover y click a las NUEVAS estrellas
        nuevasEstrellas.forEach((estrella, index) => {
          const valor = index + 1;
          
          // Evento hover: mostrar preview
          estrella.addEventListener('mouseenter', () => {
            actualizarEstrellasVisuales(valor);
          });
          
          // Evento click: enviar valoraci√≥n
          estrella.addEventListener('click', async () => {
            await enviarValoracion(valor);
          });
        });
        
        // Evento mouse leave del contenedor: volver a mostrar valoraci√≥n actual
        nuevoContenedor.addEventListener('mouseleave', () => {
          actualizarEstrellasVisuales(valoracionActual);
        });
        
        // Actualizar mensaje
        if (valoracionActual > 0) {
          document.getElementById('mensajeValoracion').textContent = `Tu valoraci√≥n: ${valoracionActual} estrella${valoracionActual === 1 ? '' : 's'}`;
        }
      }

      /**
       * Actualiza visualmente las estrellas
       * @param {number} valor - N√∫mero de estrellas a iluminar (0-5)
       */
      function actualizarEstrellasVisuales(valor) {
        const estrellas = document.querySelectorAll('.estrella-valoracion');
        estrellas.forEach((estrella, index) => {
          if (index < valor) {
            estrella.className = 'bi bi-star-fill text-warning estrella-valoracion';
          } else {
            estrella.className = 'bi bi-star text-warning estrella-valoracion';
          }
        });
      }

      /**
       * Env√≠a una valoraci√≥n al servidor
       * @param {number} puntuacion - Puntuaci√≥n de 1 a 5
       */
      async function enviarValoracion(puntuacion) {
        console.log(`‚≠ê Enviando valoraci√≥n: ${puntuacion} estrellas para "${window.recetaActualNombre}"`);
        
        try {
          const respuesta = await fetch('/api/valorar-receta', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              nombreReceta: window.recetaActualNombre,
              puntuacion: puntuacion
            })
          });
          
          const resultado = await respuesta.json();
          console.log('‚úÖ Resultado de valoraci√≥n:', resultado);
          
          if (resultado.exito) {
            // Actualizar interfaz con nueva valoraci√≥n media
            mostrarValoraciones({
              valoracionMedia: resultado.valoracionMedia,
              totalValoraciones: resultado.totalValoraciones
            });
            
            // Actualizar configuraci√≥n de estrellas
            configurarEstrellas(puntuacion);
            
            // Mostrar mensaje de √©xito
            mostrarMensajeGuardado('¬°Valoraci√≥n guardada!', 'success');
            
          } else {
            mostrarMensajeGuardado(resultado.mensaje || 'Error al guardar la valoraci√≥n', 'error');
          }
        } catch (error) {
          console.error('‚ùå Error al enviar valoraci√≥n:', error);
          mostrarMensajeGuardado('Error de conexi√≥n al enviar la valoraci√≥n', 'error');
        }
      }
    </script>

    <style>
      .hover-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }

      .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
      }

      .card-img-container img {
        transition: transform 0.3s ease;
      }

      .hover-card:hover .card-img-container img {
        transform: scale(1.05);
      }
    </style>
  </body>
</html>
