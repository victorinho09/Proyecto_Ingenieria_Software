<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- Meta tags básicos -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Recetas Guardadas - Proyecto Ingeniería del Software</title>
    <meta
      name="description"
      content="Tus recetas guardadas - Proyecto web para la asignatura de Ingeniería del Software - Universidad 2025/2026"
    />
    <meta
      name="keywords"
      content="ingeniería software, proyecto web, fastapi, html, css, javascript, recetas guardadas"
    />
    <meta name="author" content="Victor Vega Martinez" />

    <!-- Pre-conect google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Allura&display=swap" rel="stylesheet">

    <!-- CSS personalizado -->
    <link rel="stylesheet" href="/static/saborea.css">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/cocinero.png">
  </head>
  <body class="bg-light d-flex flex-column min-vh-100">
    <!-- Navegación principal -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">
          <span class="lh-1" style="font-family:'Allura',cursive; font-size:2.8rem;">Saborea</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Inicio</a>
            </li>

            <li class="nav-item dropdown d-flex align-items-center">
              <a class="nav-link active" href="/recetas">Recetas</a>
              <a
                class="nav-link dropdown-toggle dropdown-toggle-split px-1"
                href="#"
                id="navbarRecetas"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="Más opciones de Recetas"
              >
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end bg-primary bg-opacity-75 border-0 rounded-3 shadow py-2"
                aria-labelledby="navbarRecetas"
              >
                <li><a class="nav-link" href="/mis-recetas">Mis Recetas</a></li>
                <li>
                  <a class="nav-link active" href="/recetas-guardadas"
                    >Recetas Guardadas</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/menu-semanal">Menú Semanal</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="/comunidad">Comunidad</a>
            </li>
          </ul>

          <span class="navbar-text text-light me-3">
            <a
              class="bi bi-person-circle nav-link"
              href="/perfil"
              style="text-decoration: none"
            >
              <i>Perfil</i>
            </a>
          </span>

          <button
            type="button"
            class="btn btn-outline-light ms-2"
            data-bs-toggle="modal"
            data-bs-target="#cerrarSesionModal"
          >
            <i class="bi bi-box-arrow-in-left"></i> Cerrar Sesión
          </button>
        </div>
      </div>
    </nav>

    <!-- Contenido principal -->
    <main class="container-fluid py-4 flex-grow-1">
      <!-- Encabezado -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="display-6 fw-bold text-primary mb-2">
                <i class="bi bi-bookmark-heart-fill"></i> Mis Recetas Guardadas
              </h1>
              <p class="text-muted mb-0">
                Explora las recetas que has guardado para más tarde
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje de estado -->
      <div id="mensajeEstado" class="row mb-4" style="display: none">
        <div class="col-12">
          <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i>
            <span id="textoMensajeEstado">Cargando recetas guardadas...</span>
          </div>
        </div>
      </div>

      <!-- Contenedor de recetas -->
      <div class="row" id="contenedorRecetas">
        <!-- Las recetas se cargarán dinámicamente aquí -->
      </div>

      <!-- Mensaje cuando no hay recetas -->
      <div id="mensajeSinRecetas" class="row" style="display: none">
        <div class="col-12">
          <div class="text-center py-5">
            <i class="bi bi-bookmark text-muted" style="font-size: 4rem"></i>
            <h3 class="text-muted mt-3">No tienes recetas guardadas</h3>
            <p class="text-muted mb-4">
              Explora la sección de comunidad y guarda las recetas que más te gusten
            </p>
            <a href="/comunidad" class="btn btn-primary btn-lg">
              <i class="bi bi-search"></i> Explorar Recetas
            </a>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light border-top mt-auto">
      <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <img src="/static/cocinero.png" alt="Logo" style="height: 16px;" class="me-2">
            <span class="text-muted small">Saborea</span>
          </div>
          <div class="text-muted small">© 2025 • ISO 2025/2026</div>
        </div>
      </div>
    </footer>

    <!-- Modal de Cerrar Sesión -->
    <div
      class="modal fade"
      id="cerrarSesionModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cerrarSesionModalLabel">
              Cerrar Sesión
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Contenedor para mensajes -->
            <div
              id="mensajeContainer"
              class="alert"
              style="display: none"
            ></div>
            <form id="cerrarSesionForm" action="/cerrar-sesion" method="POST">
              <div id="mensajeCerrarSesion" class="alert alert-warning">
                ¿Estás seguro de querer cerrar sesión?
              </div>
            </form>
          </div>
          <div class="modal-footer" id="modalFooter">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="cerrarSesionForm"
              class="btn btn-primary"
            >
              Cerrar Sesión
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Detalle de Receta -->
    <div
      class="modal fade"
      id="detalleRecetaModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
    >
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detalleRecetaModalLabel">
              <i class="bi bi-book text-primary me-2"></i>
              <span id="tituloRecetaDetalle">Cargando...</span>
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Loading spinner -->
            <div id="loadingDetalleReceta" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando detalles de la receta...</span>
              </div>
              <p class="mt-2 text-muted">Cargando información completa...</p>
            </div>
            
            <!-- Contenido de la receta -->
            <div id="contenidoDetalleReceta" style="display: none;">
              <div class="row">
                <!-- Columna izquierda: Imagen y datos básicos -->
                <div class="col-lg-5">
                  <div class="card border-0 shadow-sm mb-4">
                    <div id="imagenRecetaDetalle" class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 300px;">
                      <!-- La imagen se cargará aquí -->
                    </div>
                    <div class="card-body">
                      <div class="row g-3">
                        <div class="col-6">
                          <div class="bg-primary bg-opacity-10 rounded p-3 text-center">
                            <i class="bi bi-clock text-primary fs-4"></i>
                            <div class="mt-2">
                              <small class="text-muted d-block">Duración</small>
                              <strong id="duracionRecetaDetalle">-</strong>
                            </div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="bg-warning bg-opacity-10 rounded p-3 text-center">
                            <i class="bi bi-star text-warning fs-4"></i>
                            <div class="mt-2">
                              <small class="text-muted d-block">Dificultad</small>
                              <strong id="dificultadRecetaDetalle">-</strong>
                            </div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="bg-success bg-opacity-10 rounded p-3 text-center">
                            <i class="bi bi-geo-alt text-success fs-4"></i>
                            <div class="mt-2">
                              <small class="text-muted d-block">País origen</small>
                              <strong id="paisOrigenRecetaDetalle">-</strong>
                            </div>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="bg-info bg-opacity-10 rounded p-3 text-center">
                            <i class="bi bi-clock-history text-info fs-4"></i>
                            <div class="mt-2">
                              <small class="text-muted d-block">Turno comida</small>
                              <strong id="turnoComidaRecetaDetalle">-</strong>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Columna derecha: Descripción, ingredientes e instrucciones -->
                <div class="col-lg-7">
                  <!-- Descripción -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-primary bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-file-text text-primary me-2"></i>
                        Descripción
                      </h6>
                    </div>
                    <div class="card-body">
                      <p id="descripcionRecetaDetalle" class="mb-0">-</p>
                    </div>
                  </div>
                  
                  <!-- Ingredientes -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-success bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-list-check text-success me-2"></i>
                        Ingredientes
                      </h6>
                    </div>
                    <div class="card-body">
                      <div id="ingredientesRecetaDetalle">
                        <p class="text-muted mb-0">No se han especificado ingredientes.</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Instrucciones -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-warning bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-list-ol text-warning me-2"></i>
                        Pasos a seguir
                      </h6>
                    </div>
                    <div class="card-body">
                      <div id="instruccionesRecetaDetalle">
                        <p class="text-muted mb-0">No se han especificado pasos a seguir.</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Alérgenos -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-danger bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                        Alérgenos
                      </h6>
                    </div>
                    <div class="card-body">
                      <div id="alergenosRecetaDetalle">
                        <p class="text-muted mb-0">No se han especificado alérgenos.</p>
                      </div>
                    </div>
                  </div>

                  <!-- Sección de Comentarios -->
                  <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-info bg-opacity-10">
                      <h6 class="mb-0">
                        <i class="bi bi-chat-dots text-info me-2"></i>
                        Comentarios
                        <span class="badge bg-info ms-2" id="contadorComentarios">0</span>
                      </h6>
                    </div>
                    <div class="card-body">
                      <!-- Formulario para añadir comentario -->
                      <div class="mb-4">
                        <label for="nuevoComentarioTexto" class="form-label fw-bold">
                          <i class="bi bi-pencil-square me-1"></i>
                          Añadir un comentario
                        </label>
                        <textarea
                          class="form-control"
                          id="nuevoComentarioTexto"
                          rows="3"
                          maxlength="500"
                          placeholder="Escribe tu comentario aquí... (máximo 500 caracteres)"
                        ></textarea>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                          <small class="text-muted">
                            <span id="contadorCaracteres">0</span>/500 caracteres
                          </small>
                          <div>
                            <button
                              type="button"
                              class="btn btn-sm btn-outline-secondary me-2"
                              id="cancelarComentarioBtn"
                            >
                              <i class="bi bi-x-circle me-1"></i>
                              Cancelar
                            </button>
                            <button
                              type="button"
                              class="btn btn-sm btn-primary"
                              id="publicarComentarioBtn"
                            >
                              <i class="bi bi-send me-1"></i>
                              Publicar
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- Lista de comentarios -->
                      <div id="listaComentarios">
                        <p class="text-muted text-center py-3">
                          <i class="bi bi-chat-quote"></i>
                          No hay comentarios aún. ¡Sé el primero en comentar!
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Error state -->
            <div id="errorDetalleReceta" style="display: none;" class="text-center py-5">
              <div class="text-danger">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Error al cargar la receta</h5>
                <p id="mensajeErrorDetalle">Ha ocurrido un error inesperado</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-danger me-auto"
              id="eliminarRecetaBtn"
              style="display: none;"
            >
              <i class="bi bi-trash me-1"></i>
              Eliminar
            </button>
            <button
              type="button"
              class="btn btn-warning"
              id="guardarRecetaBtn"
            >
              <i class="bi bi-bookmark-plus me-1"></i>
              Guardar
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              <i class="bi bi-x-circle me-1"></i>
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de confirmación de eliminación -->
    <div class="modal fade" id="confirmarEliminarModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar eliminación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p>¿Estás seguro de que quieres eliminar esta receta? Esta acción no se puede deshacer y la receta desaparecerá para todos los usuarios.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmarEliminarBtn">Eliminar receta</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script para dropdowns en hover -->
    <script>
      document
        .querySelectorAll(".nav-item.dropdown")
        .forEach(function (dropdown) {
          const toggle = dropdown.querySelector('[data-bs-toggle="dropdown"]');
          const dd = new bootstrap.Dropdown(toggle, {
            popperConfig: { strategy: "fixed" },
          });

          dropdown.addEventListener("mouseenter", () => dd.show());
          dropdown.addEventListener("mouseleave", () => dd.hide());
        });
    </script>
    
    <!-- Scripts de la aplicación -->
    <script type="module" src="/static/js/main.js"></script>
    <script type="module">
      // Script específico para recetas guardadas
      import {
        cargarRecetasGuardadas,
        desguardarReceta,
        eliminarReceta,
      } from "/static/js/services/api-service.js";
      import { mostrarMensaje } from "/static/js/components/message-handler.js";
      import {
        formatearDuracion,
        crearCardReceta,
        agregarEventListenersRecetas,
        mostrarLoadingModal,
        mostrarErrorModal,
        obtenerDetalleReceta,
        mostrarIngredientes,
        mostrarPasosAseguir,
        mostrarAlergenos,
        mostrarImagenReceta
      } from "/static/js/utils/recetas-utils.js";

      // Cargar recetas guardadas al cargar la página
      document.addEventListener("DOMContentLoaded", async function () {
        await cargarYMostrarRecetasGuardadas();
      });

      /**
       * Abre el modal de detalle de una receta
       * @param {string} recetaId - ID de la receta a mostrar
       */
      async function abrirModalDetalleReceta(recetaId) {
        const modal = new bootstrap.Modal(document.getElementById('detalleRecetaModal'));
        
        // Mostrar modal con loading
        mostrarLoadingModal();
        modal.show();
        
        try {
          const resultado = await obtenerDetalleReceta(recetaId);
          
          if (resultado.exito && resultado.receta) {
            // Pasar también el email del usuario actual (resultado.usuario) para controlar permisos
            mostrarDetalleReceta(resultado.receta, resultado.usuario);
          } else {
            mostrarErrorModal(resultado.mensaje || "No se pudo cargar la receta");
          }
        } catch (error) {
          mostrarErrorModal(error.message);
        }
      }

      /**
       * Muestra el detalle completo de una receta en el modal
       * @param {Object} receta - Objeto con los datos de la receta
       */
      function mostrarDetalleReceta(receta, emailUsuario) {
        // Ocultar loading y error, mostrar contenido
        document.getElementById('loadingDetalleReceta').style.display = 'none';
        document.getElementById('errorDetalleReceta').style.display = 'none';
        document.getElementById('contenidoDetalleReceta').style.display = 'block';

        // Llenar datos básicos
        document.getElementById('tituloRecetaDetalle').textContent = receta.nombreReceta || 'Sin nombre';
        
        // Agregar atributos de datos para referencia
        const tituloElement = document.getElementById('tituloRecetaDetalle');
        tituloElement.setAttribute('data-receta-nombre', receta.nombreReceta);
        tituloElement.setAttribute('data-receta-id', receta.id || '');
        
        document.getElementById('descripcionRecetaDetalle').textContent = receta.descripcion || 'Sin descripción';
        document.getElementById('duracionRecetaDetalle').textContent = formatearDuracion(receta.duracion || 0);
        document.getElementById('dificultadRecetaDetalle').textContent = receta.dificultad || 'No especificada';
        document.getElementById('paisOrigenRecetaDetalle').textContent = receta.paisOrigen || 'No especificado';
        
        // Formatear turno de comida
        const turnoComida = receta.turnoComida || 'No especificado';
        document.getElementById('turnoComidaRecetaDetalle').textContent = 
          turnoComida.charAt(0).toUpperCase() + turnoComida.slice(1).toLowerCase();

        // Mostrar imagen
        mostrarImagenReceta(
          receta.fotoReceta,
          receta.nombreReceta,
          document.getElementById('imagenRecetaDetalle')
        );

        // Mostrar ingredientes
        mostrarIngredientes(
          receta.ingredientes,
          document.getElementById('ingredientesRecetaDetalle')
        );

        // Mostrar pasos a seguir
        mostrarPasosAseguir(
          receta.pasosAseguir,
          document.getElementById('instruccionesRecetaDetalle')
        );

        // Mostrar alérgenos
        mostrarAlergenos(
          receta.alergenos,
          document.getElementById('alergenosRecetaDetalle')
        );

        // Configurar botón de desguardar (siempre estará guardada en esta página)
        configurarBotonDesguardar(receta);

        // Configurar botón de eliminar solo si el usuario actual es el autor
        configurarBotonEliminar(receta, emailUsuario);
        
        // Guardar ID y nombre de receta para comentarios
        window.recetaActualNombre = receta.nombreReceta;
        window.recetaActualId = receta.id;
        
        // Cargar comentarios
        if (receta.id) {
          cargarComentarios(receta.id);
        }
      }

      /**
       * Configura el botón de eliminar receta (mostrar/ocultar y evento)
       * @param {Object} receta
       * @param {string} emailUsuario - email del usuario autenticado
       */
      function configurarBotonEliminar(receta, emailUsuario) {
        const btnEliminar = document.getElementById('eliminarRecetaBtn');
        if (!btnEliminar) return;

        // Mostrar el botón solo si el usuario autenticado es el autor de la receta
        if (emailUsuario && receta.usuario && emailUsuario === receta.usuario) {
          btnEliminar.style.display = 'inline-block';
          btnEliminar.disabled = false;

          // Al pulsar el botón, abrir modal de confirmación
          btnEliminar.onclick = function() {
            const confirmarModal = new bootstrap.Modal(document.getElementById('confirmarEliminarModal'));
            // Guardar el nombre de la receta a eliminar en un atributo data
            const confirmarBtn = document.getElementById('confirmarEliminarBtn');
            confirmarBtn.setAttribute('data-nombre-receta', receta.nombreReceta);
            confirmarModal.show();
          };
        } else {
          btnEliminar.style.display = 'none';
        }
      }

      // Manejar confirmación del modal de eliminación
      document.addEventListener('DOMContentLoaded', function() {
        const confirmarBtn = document.getElementById('confirmarEliminarBtn');
        if (confirmarBtn) {
          confirmarBtn.addEventListener('click', async function() {
            const nombreReceta = this.getAttribute('data-nombre-receta');
            // Deshabilitar mientras se procesa
            this.disabled = true;
            try {
              // Llamar al endpoint de eliminación
              const resultado = await eliminarReceta(nombreReceta);

              // Cerrar modal de detalle y confirmación
              const detalleModalEl = document.getElementById('detalleRecetaModal');
              try { bootstrap.Modal.getInstance(detalleModalEl).hide(); } catch (e) {}
              const confirmarModalEl = document.getElementById('confirmarEliminarModal');
              try { bootstrap.Modal.getInstance(confirmarModalEl).hide(); } catch (e) {}

              if (resultado && resultado.success) {
                mostrarMensaje(`Receta "${nombreReceta}" eliminada correctamente`, 'success');
                // Recargar lista de recetas guardadas
                await cargarYMostrarRecetasGuardadas();
              } else {
                mostrarMensaje(resultado.data?.mensaje || 'No se pudo eliminar la receta', 'error');
                this.disabled = false;
              }
            } catch (err) {
              console.error('Error al eliminar receta:', err);
              mostrarMensaje('Error al eliminar la receta', 'error');
              this.disabled = false;
            }
          });
        }
      });

      /**
       * Configura el botón de desguardar receta
       * @param {Object} receta - Objeto con los datos de la receta
       */
      function configurarBotonDesguardar(receta) {
        const btnGuardar = document.getElementById('guardarRecetaBtn');
        if (!btnGuardar) return;

        // En recetas guardadas, el botón siempre permite desguardar
        btnGuardar.innerHTML = '<i class="bi bi-bookmark-check-fill"></i> Guardada';
        btnGuardar.className = 'btn btn-success';
        btnGuardar.disabled = false;
        
        // Configurar el evento click para desguardar
        btnGuardar.onclick = async function() {
          await desguardarRecetaYActualizar(receta.nombreReceta, btnGuardar);
        };
      }

      /**
       * Desguarda una receta y actualiza la lista
       * @param {string} nombreReceta - Nombre de la receta a desguardar
       * @param {HTMLElement} boton - Elemento del botón
       */
      async function desguardarRecetaYActualizar(nombreReceta, boton) {
        try {
          // Deshabilitar el botón mientras se procesa
          boton.disabled = true;
          
          const response = await fetch("/desguardar-receta", {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ nombreReceta: nombreReceta }),
          });

          const resultado = await response.json();

          if (resultado.exito) {
            // Cerrar el modal
            bootstrap.Modal.getInstance(document.getElementById('detalleRecetaModal')).hide();
            
            // Mostrar mensaje de éxito
            mostrarMensaje(`Receta "${nombreReceta}" desguardada correctamente`, "success");
            
            // Recargar las recetas guardadas
            await cargarYMostrarRecetasGuardadas();
          } else {
            alert(resultado.mensaje || "No se pudo desguardar la receta");
            boton.disabled = false;
          }
        } catch (error) {
          console.error("Error al desguardar receta:", error);
          alert("Error al desguardar la receta");
          boton.disabled = false;
        }
      }

      // Cargar recetas guardadas al cargar la página
      document.addEventListener("DOMContentLoaded", async function () {
        await cargarYMostrarRecetasGuardadas();
      });

      async function cargarYMostrarRecetasGuardadas() {
        const mensajeEstado = document.getElementById("mensajeEstado");
        const contenedorRecetas = document.getElementById("contenedorRecetas");
        const mensajeSinRecetas = document.getElementById("mensajeSinRecetas");

        try {
          // Mostrar mensaje de carga
          mensajeEstado.style.display = "block";
          document.getElementById("textoMensajeEstado").textContent =
            "Cargando tus recetas guardadas...";

          // Cargar recetas guardadas
          const resultado = await cargarRecetasGuardadas();

          // Ocultar mensaje de estado
          mensajeEstado.style.display = "none";

          if (resultado.success && resultado.data.recetas) {
            const recetas = resultado.data.recetas;

            if (recetas.length === 0) {
              // No hay recetas guardadas
              mensajeSinRecetas.style.display = "block";
              contenedorRecetas.innerHTML = "";
            } else {
              // Mostrar recetas usando la función compartida
              mensajeSinRecetas.style.display = "none";
              contenedorRecetas.innerHTML = recetas.map(receta => crearCardReceta(receta, true)).join("");
              
              // Agregar event listeners a las tarjetas de recetas
              agregarEventListenersRecetas(abrirModalDetalleReceta);
            }
          } else {
            throw new Error(
              resultado.data?.mensaje || "Error al cargar recetas guardadas"
            );
          }
        } catch (error) {
          console.error("Error al cargar recetas guardadas:", error);
          mensajeEstado.style.display = "none";
          mostrarMensaje(
            `Error al cargar recetas guardadas: ${error.message}`,
            "error"
          );

          // Mostrar mensaje de error
          contenedorRecetas.innerHTML = `
            <div class="col-12">
              <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle"></i>
                Error al cargar las recetas guardadas. Por favor, intenta de nuevo más tarde.
              </div>
            </div>
          `;
        }
      }

      // Hacer función global para uso en otros lugares
      window.cargarYMostrarRecetasGuardadas = cargarYMostrarRecetasGuardadas;

      /**
       * Carga y muestra los comentarios de una receta
       * @param {string} recetaId - ID de la receta
       */
      async function cargarComentarios(recetaId) {
        try {
          const response = await fetch(`/api/comentarios-receta/${recetaId}`, {
            method: "GET",
            credentials: "include",
            headers: {
              Accept: "application/json",
              "Cache-Control": "no-cache",
            },
          });

          const resultado = await response.json();
          
          if (resultado.exito) {
            // Los comentarios vienen directamente en resultado, no en resultado.data
            const comentarios = resultado.comentarios || [];
            mostrarComentarios(comentarios);
            
            // Actualizar contador
            document.getElementById('contadorComentarios').textContent = comentarios.length;
          } else {
            console.error("Error al cargar comentarios:", resultado.mensaje);
          }
        } catch (error) {
          console.error("Error al cargar comentarios:", error);
        }
      }

      /**
       * Muestra la lista de comentarios en el modal
       * @param {Array} comentarios - Array de comentarios
       */
      function mostrarComentarios(comentarios) {
        const listaComentarios = document.getElementById('listaComentarios');
        
        if (!comentarios || comentarios.length === 0) {
          listaComentarios.innerHTML = `
            <p class="text-muted text-center py-3">
              <i class="bi bi-chat-quote"></i>
              No hay comentarios aún. ¡Sé el primero en comentar!
            </p>
          `;
          return;
        }
        
        // Ordenar comentarios por fecha (más recientes primero)
        comentarios.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        
        listaComentarios.innerHTML = comentarios.map(comentario => {
          const fecha = new Date(comentario.fecha);
          const fechaFormateada = formatearFechaComentario(fecha);
          
          return `
            <div class="card mb-3 border-0 bg-light">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="mb-0 text-primary">
                    <i class="bi bi-person-circle me-1"></i>
                    ${comentario.nombreUsuario || 'Usuario'}
                  </h6>
                  <small class="text-muted">
                    <i class="bi bi-clock me-1"></i>
                    ${fechaFormateada}
                  </small>
                </div>
                <p class="mb-0">${escaparHTML(comentario.texto)}</p>
              </div>
            </div>
          `;
        }).join('');
      }

      /**
       * Formatea la fecha de un comentario de manera amigable
       * @param {Date} fecha - Fecha del comentario
       * @returns {string} Fecha formateada
       */
      function formatearFechaComentario(fecha) {
        const ahora = new Date();
        const diferencia = ahora - fecha;
        
        const segundos = Math.floor(diferencia / 1000);
        const minutos = Math.floor(segundos / 60);
        const horas = Math.floor(minutos / 60);
        const dias = Math.floor(horas / 24);
        
        if (segundos < 60) return 'Hace unos segundos';
        if (minutos < 60) return `Hace ${minutos} minuto${minutos !== 1 ? 's' : ''}`;
        if (horas < 24) return `Hace ${horas} hora${horas !== 1 ? 's' : ''}`;
        if (dias < 7) return `Hace ${dias} día${dias !== 1 ? 's' : ''}`;
        
        return fecha.toLocaleDateString('es-ES', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric' 
        });
      }

      /**
       * Escapa caracteres HTML para prevenir XSS
       * @param {string} texto - Texto a escapar
       * @returns {string} Texto escapado
       */
      function escaparHTML(texto) {
        const div = document.createElement('div');
        div.textContent = texto;
        return div.innerHTML;
      }

      /**
       * Publica un nuevo comentario en la receta
       */
      async function publicarComentario() {
        const textarea = document.getElementById('nuevoComentarioTexto');
        const texto = textarea.value.trim();
        
        if (!texto) {
          mostrarMensaje('Por favor, escribe un comentario antes de publicar.', 'warning');
          return;
        }
        
        if (!window.recetaActualNombre) {
          mostrarMensaje('Error: No se pudo identificar la receta.', 'error');
          return;
        }
        
        // Deshabilitar botón mientras se publica
        const btnPublicar = document.getElementById('publicarComentarioBtn');
        const textoOriginal = btnPublicar.innerHTML;
        btnPublicar.disabled = true;
        btnPublicar.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Publicando...';
        
        try {
          const response = await fetch('/api/comentar-receta', {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            body: JSON.stringify({
              nombreReceta: window.recetaActualNombre,
              texto: texto
            })
          });
          
          const resultado = await response.json();
          
          if (resultado.exito) {
            // Limpiar textarea
            textarea.value = '';
            document.getElementById('contadorCaracteres').textContent = '0';
            
            // Recargar comentarios usando el ID guardado
            if (window.recetaActualId) {
              await cargarComentarios(window.recetaActualId);
            }
            
            // Mostrar mensaje de éxito
            mostrarMensaje('✅ ¡Comentario publicado correctamente!', 'success');
          } else {
            mostrarMensaje(`Error al publicar comentario: ${resultado.mensaje || 'Error desconocido'}`, 'error');
          }
        } catch (error) {
          console.error('Error al publicar comentario:', error);
          mostrarMensaje('Error de conexión. No se pudo publicar el comentario.', 'error');
        } finally {
          // Restaurar botón
          btnPublicar.disabled = false;
          btnPublicar.innerHTML = textoOriginal;
        }
      }

      /**
       * Cancela el comentario y limpia el textarea
       */
      function cancelarComentario() {
        const textarea = document.getElementById('nuevoComentarioTexto');
        textarea.value = '';
        document.getElementById('contadorCaracteres').textContent = '0';
      }

      /**
       * Actualiza el contador de caracteres del comentario
       */
      function actualizarContadorCaracteres() {
        const textarea = document.getElementById('nuevoComentarioTexto');
        const contador = document.getElementById('contadorCaracteres');
        contador.textContent = textarea.value.length;
      }

      // Inicializar eventos de comentarios
      document.addEventListener("DOMContentLoaded", function() {
        // Contador de caracteres
        const textarea = document.getElementById('nuevoComentarioTexto');
        if (textarea) {
          textarea.addEventListener('input', actualizarContadorCaracteres);
        }
        
        // Botón publicar comentario
        const btnPublicar = document.getElementById('publicarComentarioBtn');
        if (btnPublicar) {
          btnPublicar.addEventListener('click', publicarComentario);
        }
        
        // Botón cancelar comentario
        const btnCancelar = document.getElementById('cancelarComentarioBtn');
        if (btnCancelar) {
          btnCancelar.addEventListener('click', cancelarComentario);
        }
      });
    </script>

    <style>
      .hover-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }

      .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
      }

      .card-img-container img {
        transition: transform 0.3s ease;
      }

      .hover-card:hover .card-img-container img {
        transform: scale(1.05);
      }
    </style>
  </body>
</html>
